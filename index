<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alveary Course Planning</title>

  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700&family=Crimson+Text:wght@700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
  <script defer src="https://unpkg.com/@alpinejs/focus@3.x.x/dist/cdn.min.js"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    /* =========================================================
       ROOT & BASE
    ========================================================= */
    :root{
      --brand-bg:#fbfbf9;
      --brand-ink:#262b26;
      --green-dark:#596e5e;
      --black-2:#505650;
      --gray-soft:#f4f6fa;
      --band-green:#596e5e;
      --check-green:#9da89f;
      --filter-label:#666d66;
    
      /* sticky heights (measured/overridden by JS) */
      --mini-steps-h:44px;   /* tiny sticky tab bar */
      --printbar-h:46px;     /* compact filter/print bar */
    }
    *{-webkit-print-color-adjust:exact!important; print-color-adjust:exact!important;}
    body{
      background:var(--brand-bg);
      color:var(--brand-ink);
      font-family:'DM Sans',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    
    /* =========================================================
       TITLES & TYPO
    ========================================================= */
    .title{
      font-weight:700; font-size:40px; line-height:1.1; color:var(--brand-ink); margin:0;
    }
    .step-title{
      font-weight:700; font-size:30px; line-height:1.2; color:var(--green-dark); margin:.5rem 0 .25rem;
    }
    .step-sub{ color:#49564f; font-size:1rem; margin:0 0 1rem; }
    
    /* =========================================================
       GUIDANCE (Step: Planning Guide)
    ========================================================= */
    .guidance-head{ display:flex; align-items:center; gap:.75rem; margin-bottom:.5rem; }
    .guidance-head img{ height:3.25rem; width:3.25rem; }
    .guidance-head h3{ font-size:1.35rem; font-weight:700; color:var(--green-dark); }
    
    .guidance-copy{ font-size:.96rem; line-height:1.55; color:#2f3a33; margin-left:2.9rem; }
    .guidance-copy p{ margin:0 0 .6rem 0; }
    .guidance-copy ul{ margin:.25rem 0 .75rem 1.25rem; }
    .guidance-copy ul li{ margin-bottom:.25rem; padding-left:.25rem; }
    
    .divider-green{ border-top:1.5px solid var(--green-dark); margin-top:1.1rem; padding-top:1.1rem; }
    
    .intro-card{
      background:#fff; border:1px solid #e7ebe8; box-shadow:0 2px 8px rgba(0,0,0,.05);
      border-radius:1rem; padding:1rem 1.25rem;
    }
    @media (min-width:640px){ .intro-card{ padding:1.25rem 1.5rem; } }
    
    .schedule-col{ font-size:.85rem; line-height:1.35; color:#2f3a33; }
    .schedule-col .label{ font-size:.72rem; letter-spacing:.06em; text-transform:uppercase; color:#6b7a71; margin-bottom:.25rem; display:block; }
    @media (min-width:640px){ .schedule-col{ padding-right:.25rem; } }
    
    .legend img{ width:18px; height:18px; border-radius:999px; }
    .legend li{ display:flex; align-items:center; gap:.4rem; }
    
    /* =========================================================
       MINI TABS (sticky #1)
    ========================================================= */
    .mini-steps{
      position:sticky; top:0; z-index:50; background:var(--brand-bg); border-bottom:1px solid #e3e7e3;
    }
    .mini-steps .rail{
      height:var(--mini-steps-h); display:flex; align-items:center; gap:.9rem;
      padding-bottom:0; margin-bottom:-1px; /* kiss print bar */
    }
    .mini-steps a{
      font-size:.95rem; color:var(--black-2);
      text-decoration:underline; text-underline-offset:3px; text-decoration-thickness:1px;
      padding:.2rem .1rem;
    }
    .mini-steps a[aria-current="true"]{ color:var(--brand-ink); text-decoration-thickness:2px; }
    
    /* =========================================================
       PRINT / FILTER BAR (sticky #2)
    ========================================================= */
    .sticky-actions{
      position:sticky; top:var(--mini-steps-h); z-index:40;
      background:var(--brand-bg); border-bottom:0; margin-top:-1px;  /* seamless to tabs */
    }
    .sticky-actions .btn{ font-size:.9rem; padding:.3rem .65rem; border-radius:.9rem; }
    .sticky-actions .btn-ghost { color: #666d66 !important; border: 1px solid #d9ded9; background: #fff; font-size: .9rem !important; font-weight: 500; }
    .sticky-actions .btn-primary{ background:var(--green-dark); color:#fff; }
    
    /* Compact filter strip inside print bar */
    .filter-strip{
      display: grid;
      align-items: center;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: .5rem;
      font-size: .9rem;
      color:#666d66
    }
    .filter-strip .mini{
      width: 100%;
      height: 30px;
      padding: .25rem .55rem;
      border: 1px solid #d9ded9;
      border-radius: .6rem;
      background: #fff;
      color:#666d66 /* control text */
    }
    .filter-strip .mini::placeholder,
    .filter-strip .mini option{ color:#666d66; }
    
    .filter-strip .chk{
      display: inline-flex;
      align-items: center;
      gap: .35rem;
      white-space: nowrap;
      font-size: .9rem;
      color:#666d66
    }
    .filter-strip .chk input{ width:16px; height:16px; }
    .filter-strip .chk span{ color: var(--filter-label); font-weight: 500; }
    .text-gray-600 strong{ color: var(--filter-label); }
    
    /* Keep Subject + Plan together when wrapping */
    .filter-strip .pair{
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: .5rem;
    }
    
    /* 4 equal columns */
    .filter-strip{
      display:grid; align-items:center;
      grid-template-columns:repeat(4, minmax(0,1fr));
      gap:.5rem; font-size:.9rem;
    }
    
    /* Search (first) and Grade (second) each take 2 columns */
    .filter-strip > .mini:nth-child(1),
    .filter-strip > .mini:nth-child(2){
      grid-column: span 2;
    }
    
    /* Subject+Plan pair spans entire row and contains 2 equal columns */
    .filter-strip .pair{
      grid-column: 1 / -1;             /* take all 4 columns */
      display:grid; grid-template-columns:repeat(2, minmax(0,1fr));
      gap:.5rem;
    }
    
    /* On narrow screens, the grid becomes 2 columns; above still works */
    @media (max-width:900px){
      .filter-strip{ grid-template-columns:repeat(2, minmax(0,1fr)); }
    }
    
    /* optional – keep the tiny Clear links tidy under selects */
    .filter-strip button[role="clear"],
    .filter-strip .area-search > button,
    .filter-strip .area-grade > button,
    .filter-strip .area-subject > button,
    .filter-strip .area-plan > button{
      font-weight: 500;
    }
    /* popover trigger styled like your .mini inputs */
    .filter-trigger{
      @apply w-full h-[30px] px-2 border border-[#d9ded9] rounded-lg bg-white text-[#666d66] flex items-center justify-between;
    }
    .filter-menu{
      position:absolute; z-index:120; margin-top:.35rem; right:0; left:0;
      background:#fff; border:1px solid #e5e7eb; border-radius:.6rem; box-shadow:0 8px 24px rgba(0,0,0,.08);
      padding:.4rem; max-height:260px; overflow:auto;
    }
    .filter-menu .row{ display:flex; align-items:center; gap:.5rem; padding:.4rem .45rem; border-radius:.5rem; }
    .filter-menu .row:hover{ background:#f7f9f7; }
    .filter-menu img{ width:18px; height:18px; border-radius:999px; }
    .filter-menu input[type="search"]{ width:100%; border:1px solid #d9ded9; border-radius:.5rem; padding:.35rem .5rem; color:#666d66; }
    /* =========================================================
       SUBJECT HEADERS (sticky #3)
    ========================================================= */
    .subject-sticky{
      position:sticky; top:calc(var(--mini-steps-h) + var(--printbar-h)); z-index:35;
      background:var(--brand-bg); padding-bottom:8px; margin-bottom:8px; border-bottom:0;
    }
    .subject-sticky::after{
      content:""; position:absolute; left:0; right:0; bottom:0; height:2px; background:#cdb4a6;
    }
    /* Subject heading typography (was removed in cleanup) */
    .subject-inner{
      display:flex; align-items:center; gap:.5rem;
      color:#262b26;
      font-family:"Crimson Text", serif;
      font-weight:700;
      font-size:1.75rem;
      line-height:1.1;
    }
    @media (min-width:768px){ .subject-inner{ font-size:1.9rem; } }
    
    /* small color dot next to subject */
    .subject-dot{
      width:14px; height:14px; border-radius:999px;
      background:var(--subject-color, #dfe4df);
      box-shadow: inset 0 0 0 2px rgba(0,0,0,.08);
    }
    
    /* keep the underline fully visible while sticky */
    .subject-sticky{
      position:sticky;
      top:calc(var(--mini-steps-h) + var(--printbar-h));
      z-index:35;
      background:var(--brand-bg);
      padding-bottom:10px;   /* breathing space */
      margin-bottom:10px;
      border-bottom:0;
    }
    .subject-sticky::after{
      content:"";
      position:absolute; left:0; right:0; bottom:0;
      height:2px; background:#cdb4a6;
    }
    /* give the first course a bit more room so it never “shaves” the line */
    .group-block .course-row:first-of-type{ margin-top:.5rem; }
    
    /* =========================================================
       COURSE & TOPIC CARDS
    ========================================================= */
    .course-row{ display:flex; align-items:stretch; gap:12px; width:100%; }
    .subject-rail{ width:5px; border-radius:10px; background:var(--subject-color, #dfe4df); flex:none; }
    
    .course-card{ flex:1 1 auto; min-width:0; border-radius:1rem; overflow:visible; background:#fff; }
    .course-band{ background:var(--band-green); color:#fff; border-top-left-radius:1rem; border-top-right-radius:1rem; overflow:visible; }
    .band-title{ font-family:"Crimson Text", serif; font-size:1.05rem; line-height:1.15; }
    .band-title button{ margin-left:.25rem; transition:background .15s ease, transform .1s ease; }
    .band-title button:hover{ transform:translateY(-1px); }
    .desc-bg{ background:var(--gray-soft); }
    input[type="checkbox"]{ accent-color:var(--check-green); }
    
    /* Pills (course + topic) */
    .pill,.topic-pill{
      background:transparent; border:2px solid #bfc4b4; border-radius:999px; padding:2px;
      display:inline-flex; align-items:center; justify-content:center; cursor:pointer;
      transition:transform .1s ease, background-color .15s ease, border-color .15s ease;
    }
    .pill:hover,.topic-pill:hover{ transform:translateY(-1px); }
    .pill.active,.topic-pill.active{ background:#bec5a6; border-color:#aeb49a; }
    .pill .icon,.topic-pill img{ width:28px; height:28px; border-radius:999px; display:block; }
    .pill .tiny,.topic-pill .tiny{ display:none!important; }
    
    .icon,.badge{ width:18px; height:18px; border-radius:999px; display:block; }
    .badge{ margin-left:.35rem; }
    .tiny{ font-size:11px; opacity:.85; }
    
    .accordion{ background:var(--gray-soft); border-top:1px solid #e5e7eb; padding:14px 16px; }
    .acc-section + .acc-section{ border-top:1px solid #e5e7eb; margin-top:12px; padding-top:12px; }
    .acc-info{ background:#fff; border-top:1px solid #e5e7eb; padding:16px; }
    
    .note-area{ padding:0; background:transparent; border:0; }
    .note-area textarea{
      width:100%; border:1px solid #d9ded9; border-radius:.5rem; min-height:72px; padding:.5rem .6rem; font-size:.9rem; background:#fff;
    }
    
    /* Topics */
    .topics-list{ font-size:.92rem; margin-left:1.75rem; }
    .topics-list .font-medium{ font-family:"DM Sans",sans-serif; }
    .topics-list span, .topics-list label span{ line-height:1.3; }
    
    .topic-row{ display:flex; align-items:flex-start; justify-content:space-between; gap:.75rem; padding:.25rem .25rem; }
    .topic-left{ display:flex; gap:.5rem; align-items:flex-start; }
    .topic-title{ font-weight:600; font-size:.95rem; line-height:1.2; }
    .topic-schedule{ font-size:.78rem; color:#647067; line-height:1.2; margin-top:.15rem; }
    
    .topic-icon{ background:#dee1d2; padding:.25rem .4rem; border-radius:.45rem; font-size:.75rem; line-height:1; }
    .topic-icon[aria-expanded="true"]{ background:#bec5a6; }
    .topic-icon:hover{ filter:brightness(.97); }
    
    .topic-icons{ display:flex; align-items:center; gap:.35rem; padding-left:.5rem; margin-left:.5rem; border-left:1px dashed #bec5a6; }
    .topic-icons .plan-trigger{ background:#dee1d2; color:#2a312b; }
    .topic-icons .plan-trigger[aria-expanded="true"], .topic-icons .plan-trigger:hover{ background:#bec5a6; }
    
    .topic-acc-note{ background:#f4f6fa; border-top:1px solid #e5e7eb; padding:12px; border-radius:.5rem; }
    .topic-acc-info{ background:#fff;    border-top:1px solid #e5e7eb; padding:12px; border-radius:.5rem; }
    
    .topic-note-area textarea{
      width:100%; border:1px solid #d9ded9; border-radius:.5rem; min-height:64px; padding:.45rem .55rem; font-size:.88rem; background:#fff;
    }
    
    /* Plan trigger buttons */
    .plan-trigger{
      background:#dee1d2; padding:.25rem .45rem; border-radius:.45rem;
      font-size:.8rem; line-height:1; color:#2a312b; border:0;
      display:inline-flex; align-items:center; gap:.35rem;
    }
    .plan-trigger:hover{ background:#eef2ee; }
    .plan-trigger[aria-expanded="true"]{ background:#bec5a6; }
    .plan-trigger svg{ width:14px; height:14px; }
    
    .course-plan-trigger{
      background:#ffffff1f!important; border:none!important; border-radius:.45rem!important;
      padding:.25rem .45rem!important; font-size:.8rem!important; line-height:1!important; color:#fff!important;
    }
    .course-plan-trigger:hover, .course-plan-trigger[aria-expanded="true"]{ background:#ffffff33!important; }
    
    .plan-anchor{ position:relative; }
    .plan-menu{
      position:absolute; right:0; top:calc(100% + .35rem); z-index:100;
      background:#fff; border:1px solid #e5e7eb; border-radius:.6rem;
      box-shadow:0 8px 24px rgba(0,0,0,.08); padding:.4rem; width:240px; color:#2a312b;
    }
    .plan-opt{ display:flex; align-items:center; gap:.5rem; padding:.45rem .5rem; border-radius:.5rem; cursor:pointer; }
    .plan-opt:hover{ background:#f7f9f7; }
    .plan-opt img{ width:18px; height:18px; border-radius:999px; }
    .plan-opt span{ color:#2a312b; font-size:.9rem; }
    
    .tag-chip{ background:transparent; border:2px solid #bfc4b4; border-radius:999px; padding:2px; display:inline-flex; align-items:center; justify-content:center; }
    .tag-chip img{ width:28px; height:28px; border-radius:999px; display:block; }
    .tag-row{ display:flex; gap:.5rem; flex-wrap:wrap; }
    
    /* =========================================================
       PRINT MODAL & PRINT VIEW
    ========================================================= */
    .print-modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.35);
      display:flex; align-items:center; justify-content:center; z-index:7000; padding:24px;
    }
    .print-modal{
      background:#fff; border:1px solid #e5e7eb; border-radius:12px;
      width:520px; max-width:95vw; max-height:80vh; overflow:auto; padding:16px 18px;
      box-shadow:0 12px 32px rgba(0,0,0,.18); z-index:7001;
    }
    .print-modal h3{ font-weight:700; color:var(--green-dark); font-size:1.05rem; }
    .print-row{ display:flex; gap:16px; margin-top:10px; }
    .print-row .col{ flex:1; }
    .print-actions{ display:flex; justify-content:flex-end; gap:8px; margin-top:14px; }
    
    #print-view{ display:none; }
    @media print{
      .app-shell > *:not(#print-view){ display:none!important; }
      #print-view{ display:block!important; }
      html,body{ background:#fff!important; }
    
      .pv-subject{ font-family:"Crimson Text",serif; font-weight:700; font-size:22px; color:#262b26; margin:18px 0 8px; padding-bottom:4px; border-bottom:4px solid var(--subject-color,#dcded6); }
      .pv-card{ border:1px solid #e6e8e5; border-radius:10px; padding:10px 12px; margin-bottom:10px; }
      .pv-title{ font-family:"Crimson Text",serif; font-size:16px; font-weight:700; color:#262b26; }
      .pv-schedule{ font-size:11px; color:#485149; margin-top:2px; }
      .pv-tags{ display:flex; gap:6px; margin-left:auto; }
      .pv-tag{ border:1.5px solid #c7ccbc; border-radius:999px; padding:1px; }
      .pv-tag img{ width:18px; height:18px; display:block; border-radius:999px; }
    
      .pv-info label, .pv-note label{ font-weight:700; font-size:11px; }
      .pv-copy.small, .pv-note p{ font-size:10.5px; line-height:1.45; color:#2b312c; }
      .pv-note, .pv-info{ margin-top:8px; border-top:1px solid #e6e8e5; padding-top:8px; }
    }
    
    /* =========================================================
       UTILITIES / FIXES
    ========================================================= */
    .step-tabs,.step-nav{ display:none!important; }     /* old UI */
    .no-print.sticky{ z-index:20; }                     /* keep below modal */
    .group-block{ position:relative; overflow:visible; }
  
    /* ===== PATCH START: subject headers, filter strip, label uniformity ===== */
    
    /* SUBJECT HEADERS (sticky #3) */
    .subject-sticky{
      position: sticky;
      top: calc(var(--mini-steps-h) + var(--printbar-h));
      z-index: 35;
      background: var(--brand-bg);
      padding-bottom: 12px;
      margin-bottom: 12px;
      border-bottom: 0;
    }
    .subject-sticky::after{
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      height: 3px;
      background: #cdb4a6;
    }
    
    /* Subject heading typography */
    .subject-inner{
      display: flex;
      align-items: center;
      gap: .5rem;
      color: #262b26;
      font-family: "Crimson Text", serif;
      font-weight: 700;
      font-size: 1.75rem;
      line-height: 1.1;
    }
    @media (min-width: 768px){
      .subject-inner{ font-size: 1.9rem; }
    }
    
    /* Ensure first course never shaves the underline */
    .group-block .course-row:first-of-type{ margin-top: .5rem; }
    
    /* Compact filter strip inside print bar */
    .filter-strip{
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: .5rem;
      align-items: center;
      font-size: .9rem;
    }
    .filter-strip > *{ min-width: 0; }
    
    /* Input + dropdowns */
    .filter-strip .mini{
      width: 100%;
      height: 30px;
      padding: .25rem .55rem;
      border: 1px solid #d9ded9;
      border-radius: .6rem;
      background: #fff;
      color: #666d66;
    }
    .filter-strip .mini::placeholder,
    .filter-strip .mini option{ color:#666d66; }
    
    /* Pair: Subject + Plan always together and balanced */
    .filter-strip .pair{
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: .5rem;
      grid-column: 1 / -1; /* span all 4 cols */
    }
    
    /* Responsive: two columns on narrow screens (2x2) */
    @media (max-width: 950px){
      .filter-strip{
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
    
    /* Checkbox text + selected count uniformity */
    .filter-strip .chk{
      display: inline-flex;
      align-items: center;
      gap: .35rem;
      font-size: .9rem;
      color: #666d66;
    }
    .filter-strip .chk input{ width:16px; height:16px; }
    .filter-strip .chk span,
    .text-gray-600 strong{
      color: #666d66;
      font-size: .9rem;
      font-weight: 500;
    }
    
    /* ===== PATCH END ===== */
    
    /* ==== OVERRIDES (added by assistant) =================================== */
    
    /* Filter layout: 4 across on wide; otherwise 2x2 with Search+Grade / Subject+Plan */
    .filter-strip{
      display:grid;
      gap:.5rem;
      align-items:center;
      grid-template-columns: repeat(2, minmax(0,1fr));
      grid-template-areas:
        "search grade"
        "subject plan";
      font-size:.9rem;
    }
    @media (min-width:1024px){
      .filter-strip{
        grid-template-columns: repeat(4, minmax(0,1fr));
        grid-template-areas: "search grade subject plan";
      }
    }
    .area-search{ grid-area: search; }
    .area-grade{  grid-area: grade; }
    .area-subject{grid-area: subject; }
    .area-plan{   grid-area: plan; }
    
    /* Let the .pair wrapper not interfere with grid placement */
    .filter-strip .pair{ display: contents; }
    
    /* Inputs / selects tone */
    .filter-strip .mini,
    .filter-strip .mini::placeholder,
    .filter-strip .mini option{ color:#666d66; }
    
    /* Uniform label + selected count */
    :root{ --filter-label:#666d66; }
    .filter-strip .chk{
      display:inline-flex; align-items:center; gap:.35rem;
      font-size:.9rem; color:var(--filter-label);
    }
    .filter-strip .chk span,
    .selected-count, .selected-count strong{
      color:var(--filter-label);
      font-size:.9rem; font-weight:500;
    }
    
    /* Subject header spacing + per-subject underline color */
    .subject-sticky{
      position:sticky;
      top:calc(var(--mini-steps-h) + var(--printbar-h));
      z-index:35;
      background:var(--brand-bg);
      padding-bottom:4px;   /* tighter gap above the line */
      margin-bottom:8px;    /* space below the line before cards */
      border-bottom:0;
    }
    .subject-sticky::after{
      content:"";
      position:absolute; left:0; right:0; bottom:0;
      height:2px;
      background: var(--subject-color, #cdb4a6);
    }
    .group-block .course-row:first-of-type{ margin-top:.5rem; }  /* keep line visible */
    
    /* ======================================================================= */
    
    /* ==== FINAL OVERRIDES (enforce 2 tidy rows + uniform labels + subject header) ==== */
    
    /* Filter layout: always 2 rows on small screens (Search+Grade / Subject+Plan);
       becomes 4 across on >= 1024px */
    .filter-strip{
      display:grid !important;
      gap:.5rem !important;
      align-items:center !important;
      grid-template-columns: repeat(2, minmax(0,1fr)) !important;
      grid-template-areas:
        "search grade"
        "subject plan" !important;
      font-size:.9rem !important;
    }
    @media (min-width:1024px){
      .filter-strip{
        grid-template-columns: repeat(4, minmax(0,1fr)) !important;
        grid-template-areas: "search grade subject plan" !important;
      }
    }
    .area-search{ grid-area: search !important; }
    .area-grade{  grid-area: grade  !important; }
    .area-subject{grid-area: subject !important; }
    .area-plan{   grid-area: plan    !important; }
    .filter-strip .pair{ display: contents !important; }
    
    /* Controls text tone */
    .filter-strip .mini,
    .filter-strip .mini::placeholder,
    .filter-strip .mini option{ color:#666d66 !important; }
    
    /* Uniform labels + selected count */
    :root{ --filter-label:#666d66; }
    .filter-strip .chk{
      display:inline-flex; align-items:center; gap:.35rem;
      font-size:.9rem !important; color:var(--filter-label) !important;
    }
    .filter-strip .chk input{ width:16px; height:16px; }
    .filter-strip .chk span,
    .selected-count,
    .selected-count strong{
      color:var(--filter-label) !important;
      font-size:.9rem !important;
      font-weight:500 !important;
    }
    
    /* Subject headers: mirror print view (spacing + underline weight + color) */
    .subject-sticky{
      position:sticky;
      top:calc(var(--mini-steps-h) + var(--printbar-h));
      z-index:35;
      background:var(--brand-bg);
      padding-bottom:4px !important;
      margin:18px 0 8px !important;
      border-bottom:0;
    }
    .subject-sticky::after{
      content:""; position:absolute; left:0; right:0; bottom:0;
      height:4px !important;
      background: var(--subject-color, #dcded6) !important;
    }
    .subject-inner{
      font-family:"Crimson Text", serif !important;
      font-weight:700 !important;
      font-size:1.9rem !important;
      line-height:1.1 !important;
      color:#262b26 !important;
      display:flex; align-items:center; gap:.5rem;
    }
    .group-block .course-row:first-of-type{ margin-top:.6rem !important; }
    
    /* ========================================================================= */
    
    /* === FINAL, SINGLE SOURCE OF TRUTH FOR FILTER STRIP + LABELS === */
    :root{ --filter-label:#666d66; }
    
    /* Layout: only 2x2 (search+grade / subject+plan) or 4-across on >=1024px */
    .filter-strip{ 
      display:grid !important; gap:.5rem !important; align-items:center !important;
      grid-template-columns:repeat(2, minmax(0,1fr)) !important;
      grid-template-areas:
        "search grade"
        "subject plan" !important;
    }
    @media (min-width:1024px){
      .filter-strip{
        grid-template-columns:repeat(4, minmax(0,1fr)) !important;
        grid-template-areas:"search grade subject plan" !important;
      }
    }
    .area-search{ grid-area:search !important; }
    .area-grade{ grid-area:grade !important; }
    .area-subject{ grid-area:subject !important; }
    .area-plan{ grid-area:plan !important; }
    .filter-strip .pair{ display:contents !important; }
    
    /* Controls visual tone */
    .filter-strip .mini,
    .filter-strip .mini::placeholder,
    .filter-strip .mini option{ color:#666d66 !important; }
    
    /* Uniform labels (checkbox text) + selected count — works inside OR outside .filter-strip */
    .chk{ display:inline-flex; align-items:center; gap:.35rem; }
    .chk span, .selected-count, .selected-count strong{
      color:var(--filter-label) !important;
      font-size:.9rem !important;
      font-weight:500 !important;
    }
    
    /* Subject headers — match print view */
    .subject-inner{
      font-family:"Crimson Text",serif !important; font-weight:700 !important;
      font-size:1.9rem !important; line-height:1.1 !important; color:#262b26 !important;
    }
    .subject-sticky{
      position:sticky; top:calc(var(--mini-steps-h) + var(--printbar-h));
      z-index:35; background:var(--brand-bg);
      padding-bottom:4px !important; margin:18px 0 8px !important; border-bottom:0 !important;
    }
    .subject-sticky::after{
      content:""; position:absolute; left:0; right:0; bottom:0;
      height:4px !important; background:var(--subject-color,#dcded6) !important;
    }
    .group-block .course-row:first-of-type{ margin-top:.6rem !important; }
    
    /* === FINAL LAYOUT + LABEL TONE (safe override) === */
    :root { --filter-label: #666d66; }
    
    /* Layout: 2 rows on narrow (Search|Grade / Subject|Plan), 4-across ≥1024px */
    .filter-strip{
      display: grid !important;
      gap: .5rem !important;
      align-items: center !important;
      grid-template-columns: repeat(2, minmax(0,1fr)) !important;
      grid-template-areas:
        "search grade"
        "subject plan" !important;
    }
    @media (min-width: 1024px){
      .filter-strip{
        grid-template-columns: repeat(4, minmax(0,1fr)) !important;
        grid-template-areas: "search grade subject plan" !important;
      }
    }
    
    /* Place each control in its area; let the wrapper not interfere */
    .area-search  { grid-area: search  !important; }
    .area-grade   { grid-area: grade   !important; }
    .area-subject { grid-area: subject !important; }
    .area-plan    { grid-area: plan    !important; }
    .filter-strip .pair { display: contents !important; }
    
    /* Control text tone to #666d66 */
    .filter-strip .mini,
    .filter-strip .mini::placeholder,
    .filter-strip .mini option { color: #666d66 !important; }
    
    /* Checkbox labels + selected count unified */
    .chk { display: inline-flex; align-items: center; gap: .35rem; }
    .chk span,
    .selected-count,
    .selected-count strong {
      color: var(--filter-label) !important;
      font-size: .9rem !important;
      font-weight: 500 !important;
    }
    /* === TYPE SYSTEM & COLORS (courses > topics > other) === */
    :root { --ink: #262b26; }
    
    .course-band .band-title{
      font-family: 'DM Sans', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif !important;
      font-weight: 700;
      font-size: 1.15rem;              /* Courses = largest */
      line-height: 1.2;
      color: #fff;                      /* Courses in white */
    }
    @media (min-width:768px){
      .course-band .band-title{ font-size: 1.25rem; }
    }
    
    .topic-title{
      font-family: 'DM Sans', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-weight: 700;
      font-size: 1rem;                  /* Topics = medium */
      line-height: 1.2;
      color: var(--ink);                /* All non-course text in #262b26 */
    }
    
    .text-[0.8rem], .topic-schedule,
    .acc-info, .topic-acc-info,
    .accordion, .note-area textarea{
      color: var(--ink);
    }
    
    /* Slightly quieter schedules */
    .text-[0.8rem], .topic-schedule{ opacity:.9; }
    
    /* === TWO-COLUMN INFO LAYOUT (Course & Topic info trays) === */
    .acc-info, .topic-acc-info{
      background: #fff;
      border-top: 1px solid #e5e7eb;
      padding: 16px;
      border-radius: .5rem;
    }
    
    .info-grid{
      position: relative;
      display: grid;
      grid-template-columns: 1fr 1fr;   /* two columns */
      gap: 1rem 1.25rem;
    }
    @media (max-width:820px){
      .info-grid{ grid-template-columns: 1fr; }  /* stack on narrow */
    }
    
    /* faint vertical divider */
    .info-grid::before{
      content:"";
      position:absolute;
      top:0; bottom:0;
      left:50%; transform:translateX(-.5px);
      width:1px; background:#e7ebe8; opacity:.6;
    }
    @media (max-width:820px){ .info-grid::before{ display:none; } }
    
    .info-col h4{
      margin:0 0 .25rem;
      font: 700 .95rem/1.25 'DM Sans', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--ink);
    }
    .info-col .copy{
      font-size: .95rem;                /* Other info = smallest */
      line-height: 1.55;
      color: var(--ink);
    }
    
    /* Make sure any legacy Crimson styles on titles don’t win */
    .band-title, .pv-title { font-family: 'DM Sans', sans-serif !important; }
    /* === UNIFIED SMALLER TYPE SCALE (screen + print) === */
    .course-band .band-title{
      font-size: .9rem;      /* Courses — smaller */
      line-height: 1.15;
    }
    @media (min-width:768px){
      .course-band .band-title{ font-size: 1rem; }
    }
    
    .topic-title{
      font-size: .82rem;     /* Topics — slightly smaller again */
      line-height: 1.2;
    }
    
    .text-[0.8rem], .topic-schedule{
      font-size: .7rem;      /* Schedules — condensed */
      line-height: 1.25;
    }
    
    .info-col h4{
      font: 700 .82rem/1.2 'DM Sans', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .info-col .copy{
      font-size: .82rem;
      line-height: 1.45;
    }
    
    /* Print view sizing to match on-screen scale */
    @media print{
      .pv-subject{
        font-size: 18px !important;
        line-height: 1.1 !important;
      }
      .pv-title{
        font-size: 13px !important;
        line-height: 1.25 !important;
      }
      .pv-schedule{
        font-size: 9.5px !important;
        line-height: 1.25 !important;
      }
      .pv-copy.small, .pv-note p{
        font-size: 9.5px !important;
        line-height: 1.4 !important;
      }
      label, .pv-info label, .pv-note label{
        font-size: 9.5px !important;
      }
    }
    /* --- Topic title a bit larger (still < course) --- */
    .topic-title{
      font-size: .98rem;        /* was .95rem */
      line-height: 1.2;
    }
    
    /* --- Stronger topic info separator (only when topic info tray is open) --- */
    .topic-acc-info{
      border-top: 2px solid #adb58f;   /* was 1px #e5e7eb */
    }
    .print-modal h3 {
      font-weight: 700;
      color: var(--green-dark);
      font-size: 1.05rem;
      margin-bottom: 0.5rem;
    }
    .print-modal label {
      font-size: 0.95rem;
      color: #262b26;
    }
    .print-modal .print-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
    }
    /* === Keep topic info toggle light even when active === */
    .topic-icon {
      background: #dee1d2 !important;    /* light green-gray base */
      color: #262b26;
      padding: .25rem .4rem;
      border-radius: .45rem;
      font-size: .75rem;
      line-height: 1;
      transition: background .15s ease;
    }
    .topic-icon:hover {
      filter: brightness(.97);
    }
    /* prevent darker color on toggle */
    .topic-icon[aria-expanded="true"] {
      background: #dee1d2 !important;
      filter: none !important;
    }
    /* More inner padding for the print dialog */
    .print-modal{
      padding: 24px 28px !important;   /* was 16px 18px */
    }
    
    /* Nice section rhythm (optional but tidy) */
    .print-modal h3{ margin-bottom: .75rem !important; }
    .print-modal .border-b{ margin-top: .75rem !important; }
    .print-modal .print-actions{ margin-top: 1rem !important; padding-top: .75rem !important; }
    /* trigger matches your mini input look */
    .ms-trigger{
      display:flex; align-items:center; gap:.5rem; width:100%;
      min-height:38px; padding:6px 10px; border:1px solid #d9ded9; border-radius:12px;
      background:#fff; color:#666d66;
    }
    .ms-trigger .chips{ display:flex; gap:.35rem; flex-wrap:wrap; }
    .ms-chip{
      display:inline-flex; align-items:center; padding:2px 8px; border-radius:999px;
      background:#f3f5f3; font-size:12px; line-height:1.2; color:#4a524a;
    }
    .ms-caret{ margin-left:auto; font-size:12px; }
    
    /* Multi-select dropdown panel — anchored to trigger via inline style */
    .ms-panel{
      position: absolute;                /* let JS set left/top inline */
      z-index: 1200;                     /* above the toolbar */
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,.08);
      max-height: 280px;                 /* prevent super tall lists */
      overflow: auto;
      padding: .4rem;
      margin-top: 0;                     /* no extra offset */
      width: auto;                       /* JS will match trigger width */
    }
    .ms-row{ display:flex; align-items:center; gap:.5rem; padding:.45rem .5rem; border-radius:8px; }
    .ms-row:hover{ background:#f7f9f7; }
    .ms-icon{ width:18px; height:18px; border-radius:999px; }
    .ms-search{ width:100%; border:1px solid #d9ded9; border-radius:8px; padding:.4rem .6rem; color:#666d66; }
    /* pill switch */
    .switch {
      position: relative; display:inline-flex; align-items:center; cursor:pointer;
      width: 44px; height: 24px; border-radius: 999px; background:#d9ded9;
      transition: background .18s ease;
    }
    .switch.on { background:#596e5e; }         /* your green-dark */
    .switch .knob {
      position:absolute; top:3px; left:3px; width:18px; height:18px; border-radius:999px;
      background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.2); transition:left .18s ease;
    }
    .switch.on .knob { left: 23px; }
    /* smaller unified filter controls */
    .filter-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #666d66;          /* same grey tone as other labels */
      font-weight: 500;
    }
    
    /* size-reduced switch */
    .switch {
      position: relative;
      display: inline-flex;
      align-items: center;
      cursor: pointer;
      width: 36px; height: 18px;
      border-radius: 999px;
      background: #d9ded9;
      transition: background .18s ease;
    }
    .switch.on { background: #596e5e; }
    .switch .knob {
      position: absolute; top: 2px; left: 2px;
      width: 14px; height: 14px;
      border-radius: 999px;
      background: #fff;
      box-shadow: 0 1px 2px rgba(0,0,0,.2);
      transition: left .18s ease;
    }
    .switch.on .knob { left: 20px; }
    
    /* switch text next to it */
    .switch-text {
      font-size: 11px;
      color: #666d66;
    }
    .toolbar-card{
      background:#f7f9f7;              /* very light tint */
      border:1px solid #e1e6e1;
      border-radius:12px;
      padding:8px 10px;
    }
    .toolbar-title{
      font-size:11px; text-transform:uppercase; letter-spacing:.04em;
      color:#666d66; font-weight:600; margin-bottom:6px;
    }
    .btn-mini{
      padding:.25rem .5rem; border-radius:.75rem; font-size:11px;
      border:1px solid #cfd4cf; background:#fff;
    }
    .btn-mini:hover{ background:#f1f4f1; }
    .btn-primary-mini{
      padding:.25rem .6rem; border-radius:.75rem; font-size:11px;
      background:#596e5e; color:#fff; box-shadow:0 1px 2px rgba(0,0,0,.08);
    }
    .switch-wrap{ display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; }
    .switch-label{ font-size:11px; color:#666d66; }
    
    /* === Filter action/switch trays: remove chrome + unify sizing === */
    /* Remove visible box + padding; keep the layout space */
    .toolbar-card{
      background: transparent !important;
      border: none !important;
      padding: 0 !important;
    }
    
    /* Hide “Actions” / “View options” titles */
    .toolbar-title{ display: none !important; }
    
    /* Make all controls in the bottom row use the same small type
       as the “Clear” links under the filters (≈12px) */
    .bottom-controls,
    .bottom-controls .btn-mini,
    .bottom-controls .btn-primary-mini,
    .bottom-controls .switch-label,
    .bottom-controls .switch-text{
      font-size: 12px !important;
      line-height: 1.25 !important;
      color: #666d66;       /* same tone as the Clear links */
      font-weight: 500;
    }
    
    /* Tighten buttons a bit so the row feels compact */
    .bottom-controls .btn-mini{
      padding: .22rem .5rem !important;
      border-radius: .7rem !important;
      border: 1px solid #cfd4cf;
      background: #fff;
    }
    .bottom-controls .btn-mini:hover{ background:#f1f4f1; }
    
    .bottom-controls .btn-primary-mini{
      padding: .22rem .6rem !important;
      border-radius: .7rem !important;
      background:#596e5e; color:#fff;
    }
    
    /* Keep the switches visually in the same vertical rhythm as buttons */
    .bottom-controls .switch-wrap{
      display:flex; align-items:center; gap:.6rem; flex-wrap:wrap;
    }
    
    /* Match switch size to the 12px label text */
    .bottom-controls .switch{
      width: 34px; height: 18px;            /* a hair smaller than before */
      background:#d9ded9;
      border-radius:999px;
    }
    .bottom-controls .switch.on{ background:#596e5e; }
    .bottom-controls .switch .knob{
      width: 14px; height: 14px; top: 2px; left: 2px;
    }
    .bottom-controls .switch.on .knob{ left: 18px; }
    
    /* Small labels flanking the switches */
    .bottom-controls .switch-label,
    .bottom-controls .switch-text{
      color:#666d66;
    }
    
    /* Ensure both columns vertically center to the same height */
    .bottom-controls{ align-items: center; }
    /* add space below each Clear link under filters */
    .filter-strip button[role="clear"],
    .filter-strip .area-search > button,
    .filter-strip .area-grade > button,
    .filter-strip .area-subject > button,
    .filter-strip .area-plan > button {
      margin-bottom: 0.4rem;   /* adjust for preferred spacing */
      display: inline-block;
    }
    
    /* Optional: give a breath of space above the bottom row */
    #actionsBar .bottom-controls{ margin-top: .3rem; }
    /* keep teleported panel on top & viewport-anchored */
    .ms-panel{ position:fixed !important; z-index:7000 !important; }
    /* dropdowns should never be clipped by the sticky bars */
    .mini-steps,
    .sticky-actions { overflow: visible !important; }
    
    /* keep the panel on top of everything */
    .ms-panel { position: fixed !important; z-index: 7000 !important; }
    .btn[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
    }
    /* --- Seam seal for sticky bars (prevents green line showing through) --- */
    .sticky-actions { margin-top: 0 !important; }            /* stop the -1px kiss */
    .mini-steps .rail { margin-bottom: 0 !important; }
    
    /* paint a small background strip past the bottom edge */
    .mini-steps,
    .sticky-actions,
    .subject-sticky { position: sticky; background: var(--brand-bg); }
    
    .mini-steps::after,
    .sticky-actions::after{
      content:"";
      position:absolute; left:0; right:0; bottom:-2px; height:4px;
      background:var(--brand-bg);
      pointer-events:none;
    }
    
    /* also seal the top edge of each subject header */
    .subject-sticky::before{
      content:"";
      position:absolute; left:0; right:0; top:-2px; height:4px;
      background:var(--brand-bg);
      pointer-events:none;
    }
    .app-shell > header{ margin-bottom:.75rem !important; }   /* header gap */
    .mini-steps{ margin-bottom:.25rem !important; }           /* tabs gap   */
    #actionsBar{ padding-top:.5rem !important; padding-bottom:.5rem !important; }
    .panel .mt-3{ margin-top:.25rem !important; }             /* helper row */
    .panel .w-full.border-t{ margin-top:.25rem !important; padding-top:.25rem !important; }
  </style>
  
</head>
<body>
<div class="app-shell max-w-6xl mx-auto p-4 sm:p-6 lg:p-8"
     :class="{'has-printbar': step===3}"
     x-data="planningApp()" x-init="init()">

  <!-- Header -->
  <header class="flex items-center gap-3 mb-3">
    <img src="Alveary%20Lt.%20Green.png" alt="" class="h-10 w-10 object-contain">
    <h1 class="title">Alveary Course Planning</h1>
  </header>
  <nav class="mini-steps no-print mb-2">
    <div class="rail max-w-6xl mx-auto px-4">
      <a href="#" @click.prevent="openStep(1)" :aria-current="step===1">How To</a>
      <a href="#" @click.prevent="openStep(2)" :aria-current="step===2">Planning Guide</a>
      <a href="#" @click.prevent="openStep(3)" :aria-current="step===3">Course List</a>
    </div>
  </nav>
  
  <!-- HOW TO (Step = 1) -->
  <section x-show="step===1" x-cloak class="mb-6">
    <h2 class="step-title">How To</h2>
    <p class="step-sub">Become familiar with our course planning tools by reading the information below.</p>
  
    <div class="rounded-2xl border border-gray-200 bg-white p-5">
      <!-- Add instructions, graphics, and an embedded tutorial video here. -->
      <p class="text-gray-700 m-0">Tutorial content coming soon.</p>
    </div>
  </section>
  
  <!-- PLANNING GUIDE (Step = 2) -->
  <section x-show="step===2" x-cloak>
    <h2 class="step-title">Planning Guide</h2>
    <p class="step-sub">Read the course planning guide.</p>
    
      <!-- Guidance card -->
      <div class="intro-card mb-6">
        <!-- italic intro -->
        <p class="italic text-base leading-relaxed text-gray-700 m-0 mb-4">
          The guidance below is designed to help you plan your year with intention and grace.
          A Charlotte Mason education should fit the child, not force the child to fit the curriculum.
        </p>
    
        <!-- Guidance list inside the same card -->
        <template x-for="(g, i) in guidance" :key="g.key">
          <div class="guidance-block">
            <div class="guidance-head flex items-center gap-3">
              <img :src="g.icon" class="h-9 w-9" alt="">
              <h3 class="text-xl font-semibold text-[var(--green-dark)]" x-text="g.title"></h3>
            </div>
    
            <div class="guidance-copy" x-html="g.html"></div>
    
            <div x-show="i < guidance.length - 1" class="divider-green"></div>
          </div>
        </template>
      </div>
    </section>
   
    <!-- COURSE LIST (Step = 3) -->
    <section x-show="step===3" x-cloak>
      <h2 class="step-title">Course List</h2>
      <p class="step-sub">Choose your courses.</p>
    
      <!-- Filters / view controls -->
      <section class="panel mb-4">
        <!-- helper row: tip + legend -->
        <div class="mt-1 text-sm text-gray-700 flex flex-col items-start gap-3">
            <ul class="legend flex flex-wrap items-center gap-3">
              <li><img src="Core%20Subjects.png" alt=""> Core</li>
              <li><img src="Family%20Subjects.png" alt=""> Family</li>
              <li><img src="Combine%20Subjects.png" alt=""> Combine</li>
              <li><img src="High%20Interest%20Subjects.png" alt=""> High Interest</li>
              <li><img src="Additional%20Subjects.png" alt=""> Additional</li>
            </ul>
          <div>
            <em>Tip:</em> Click <strong>“i”</strong> on any course or topic to view Description and Combining &amp; Placement guidance.
          </div>
          <div class="w-full border-t border-gray-200 pt-4"></div>
        </div>
    </section>

    <!-- Sticky actions -->
    <div id="actionsBar" class="sticky-actions -mx-4 sm:-mx-6 lg:-mx-8 px-4 sm:px-6 lg:px-8 py-2 flex items-center gap-3 justify-end">
      <div class="w-full">
        <!-- TOP ROW -->
        <div class="filter-strip">
          <!-- SEARCH -->
          <div class="area-search">
            <input
              class="mini w-full"
              type="search"
              placeholder="Search…"
              x-model.trim.debounce.250ms="search"
              aria-label="Search"
            />
            <button type="button" class="block mt-1 text-[12px] underline text-[#666d66]" @click="search=''">Clear</button>
          </div>
        
          <!-- GRADE (multi) -->
          <div class="area-grade"
               x-data="multiSelect({ placeholder:'Grade', modelValue: filters.levelTags, options: gradeOptions })"
               x-model="filters.levelTags"
               x-ref="msRoot">
            <div class="relative">
              <button type="button" class="ms-trigger"
                @click="open = !open; if(open) $nextTick(() => updatePanelPos($refs.msRoot))"
                :aria-expanded="open">
                <div class="chips" x-show="value.length">
                  <template x-for="t in labelChips" :key="t"><span class="ms-chip" x-text="t"></span></template>
                </div>
                <span x-show="!value.length" x-text="placeholder"></span>
                <span class="ms-caret">▾</span>
              </button>
          
              <!-- Teleport the panel to <body> so it can't be clipped -->
              <template x-teleport="body">
                <div class="ms-panel"
                     x-show="open"
                     x-transition
                     :style="panelStyle"
                     @click.outside="open=false"
                     @keydown.window="closeOnEscape($event)">
                  <template x-for="opt in shown" :key="opt.value">
                    <label class="ms-row cursor-pointer">
                      <input type="checkbox" :checked="isOn(opt.value)" @change="toggle(opt.value)">
                      <span x-text="opt.label"></span>
                    </label>
                  </template>
                </div>
              </template>
            </div>
            <button type="button" class="block mt-1 text-[12px] underline text-[#666d66]" @click="clear()">Clear</button>
          </div>
        
          <!-- SUBJECT (multi) -->
          <div class="area-subject"
               x-data="multiSelect({
                 placeholder: 'Subject',
                 modelValue: filters.subjects,
                 options: subjectList.map(s => ({ value: s, label: s }))   /* no search */
               })"
               x-model="filters.subjects"
               x-ref="msRoot">
            <div class="relative">
              <button type="button" class="ms-trigger"
                @click="open = !open; if(open) $nextTick(() => updatePanelPos($refs.msRoot))"
                :aria-expanded="open">
                <div class="chips" x-show="value.length">
                  <template x-for="t in labelChips" :key="t">
                    <span class="ms-chip" x-text="t"></span>
                  </template>
                </div>
                <span x-show="!value.length" x-text="placeholder"></span>
                <span class="ms-caret">▾</span>
              </button>
          
              <!-- Teleport to body -->
              <template x-teleport="body">
                <div class="ms-panel"
                     x-show="open"
                     x-transition
                     :style="panelStyle"
                     @click.outside="open=false"
                     @keydown.window="closeOnEscape($event)">
                  <template x-for="opt in shown" :key="opt.value">
                    <label class="ms-row cursor-pointer">
                      <input type="checkbox" :checked="isOn(opt.value)" @change="toggle(opt.value)">
                      <span x-text="opt.label"></span>
                    </label>
                  </template>
                </div>
              </template>
            </div>
            <button type="button"
                    class="block mt-1 text-[12px] underline text-[#666d66]"
                    @click="clear()">Clear</button>
          </div>
        
          <!-- PLAN TAGS (multi) -->
          <div class="area-plan"
               x-data="multiSelect({
                 placeholder: 'Plan tags',
                 modelValue: filters.planUses,
                 /* include a (none) option + your icon-capable useOptions */
                 options: [{ value: '(none)', label: '(none)' }]
                          .concat(useOptions.map(u => ({ value: u.value, label: u.label, icon: u.icon })))
               })"
               x-model="filters.planUses"
               x-ref="msRoot">
            <div class="relative">
              <button type="button" class="ms-trigger"
                      @click="open = !open; if(open) $nextTick(() => updatePanelPos($refs.msRoot))"
                      :aria-expanded="open">
                <div class="chips" x-show="value.length">
                  <template x-for="t in labelChips" :key="t">
                    <span class="ms-chip" x-text="t"></span>
                  </template>
                </div>
                <span x-show="!value.length" x-text="placeholder"></span>
                <span class="ms-caret">▾</span>
              </button>
          
              <!-- Teleport to body -->
              <template x-teleport="body">
                <div class="ms-panel"
                     x-show="open"
                     x-transition
                     :style="panelStyle"
                     @click.outside="open=false"
                     @keydown.window="closeOnEscape($event)">
                  <template x-for="opt in shown" :key="opt.value">
                    <label class="ms-row cursor-pointer">
                      <input type="checkbox" :checked="isOn(opt.value)" @change="toggle(opt.value)">
                      <!-- optional icon if present -->
                      <img class="ms-icon" x-show="opt.icon" :src="opt.icon" alt="" />
                      <span x-text="opt.label"></span>
                    </label>
                  </template>
                </div>
              </template>
            </div>
            <button type="button"
                    class="block mt-1 text-[12px] underline text-[#666d66]"
                    @click="clear()">Clear</button>
          </div>
        </div>
      
        <!-- BOTTOM ROW: aligned under the two columns of filters -->
        <div class="mt-2 grid grid-cols-1 lg:grid-cols-2 gap-3 items-center bottom-controls">
        
          <!-- Left: Actions -->
          <div class="toolbar-card">
            <div class="toolbar-title">Actions</div>
            <div class="flex flex-wrap items-center gap-2">
              <button type="button" class="btn btn-ghost flex items-center gap-2" @click="clearSelected()">Clear selected</button>
              <button type="button" class="btn btn-ghost flex items-center gap-2" @click="clearFilters()">Clear filters</button>

              <button 
                @click="refreshData()" 
                class="btn btn-ghost flex items-center gap-2"
                :disabled="isRefreshing"
              >
                <!-- Spinner -->
                <svg 
                  x-show="isRefreshing" 
                  class="animate-spin h-4 w-4 text-[var(--green-dark)]"
                  xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                >
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                  <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/>
                </svg>
              
                <!-- Text changes based on state -->
                <span x-text="isRefreshing ? 'Refreshing…' : '↻ Refresh'"></span>
              </button>
        
              <button type="button" class="btn btn-primary flex items-center gap-2" @click="openPrintDialog()">Print</button>
            </div>
          </div>
        
          <!-- Right: View options (switches) -->
          <div class="toolbar-card md:border-l-0">
            <div class="toolbar-title">View options</div>
        
            <div class="switch-wrap">
              <!-- Descriptions & tips -->
              <span class="switch-label">Descriptions &amp; tips</span>
              <button type="button"
                      class="switch"
                      :class="showAllTips ? 'on' : ''"
                      @click="toggleTips()"
                      :aria-pressed="showAllTips"
                      :aria-label="showAllTips ? 'Hide descriptions & tips' : 'Show descriptions & tips'">
                <span class="knob"></span>
              </button>
              <span class="switch-text" x-text="showAllTips ? 'On' : 'Off'"></span>
        
              <!-- Only selected -->
              <span class="switch-label md:ml-4">Only selected</span>
              <button type="button"
                      class="switch"
                      :class="onlyChecked ? 'on' : ''"
                      @click="onlyChecked = !onlyChecked"
                      :aria-pressed="onlyChecked"
                      :aria-label="onlyChecked ? 'Show all' : 'Show only selected'">
                <span class="knob"></span>
              </button>
              <span class="switch-text" x-text="onlyChecked ? 'On' : 'Off'"></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Print Options Modal -->
    <template x-teleport="body">
      <div
        x-show="printUI.open"
        x-transition.opacity
        class="print-modal-backdrop no-print"
        @click.self="printUI.open=false"
        x-trap.noscroll="printUI.open"
      >
        <div class="print-modal" role="dialog" aria-modal="true">
          <h3>Print Options</h3>

          <!-- === PRINT SECTION === -->
          <div class="mt-2 pb-3 border-b border-gray-200">
            <div class="text-xs uppercase tracking-wide text-gray-500 mb-1">Print</div>
          
            <label class="flex items-center gap-2 mt-1">
              <input type="checkbox" x-model="printUI.selectedOnly">
              <span>Print Selected</span>
            </label>
          
            <label class="flex items-center gap-2 mt-2">
              <input type="checkbox" x-model="printUI.filtered">
              <span>Print Filtered</span>
            </label>
          
            <p class="text-[11px] text-gray-500 mt-2" x-show="printUI.filtered">
              Uses your current search, subject, grade, plan, and other filters.
            </p>
          
            <template x-if="printUI.warning">
              <p class="text-sm text-red-600 mt-2" x-text="printUI.warning"></p>
            </template>
          </div>
          
          <!-- === INCLUDE SECTION === -->
          <div class="pt-3">
            <div class="text-xs uppercase tracking-wide text-gray-500 mb-1">Include</div>
          
            <label class="flex items-center gap-2 mt-1">
              <input type="checkbox" x-model="printUI.includeInfo">
              <span>Descriptions &amp; combining tips</span>
            </label>
          
            <label class="flex items-center gap-2 mt-2">
              <input type="checkbox" x-model="printUI.includeNotes">
              <span>Planning notes</span>
            </label>
          </div>
          
          <!-- === ACTION BUTTONS === -->
          <div class="print-actions mt-5 pt-3 border-t border-gray-200">
            <button @click="printUI.open=false" class="rounded-xl px-3 py-2 border border-gray-300">
              Cancel
            </button>
            <button @click="doPrint()" class="rounded-xl px-3 py-2 bg-[var(--green-dark)] text-white">
              Preview &amp; Print
            </button>
          </div>
          
        </div>
      </div>
    </template>
  <!-- Course list -->
  <section>
    <!-- subject groups -->
    <template x-for="grp in groupedBySubject" :key="grp.subject || 'other'">
      <div class="group-block">
        <!-- full-width sticky subject bar (matches Clear/Print width trick) -->
        <div class="subject-sticky no-print -mx-4 sm:-mx-6 lg:-mx-8 px-4 sm:px-6 lg:px-8"
             :style="{ '--subject-color': grp.color }">
          <div class="subject-inner">
            <span class="subject-dot"></span>
            <span x-text="grp.subject || 'Other'"></span>
          </div>
        </div>
  
        <!-- courses in this subject -->
        <template x-for="c in grp.items" :key="c.id">
          <div class="course-row" :style="{ '--subject-color': grp.color }">
            <div class="subject-rail"></div>
            <div class="course-card mb-3 rounded-2xl shadow-sm bg-white">
  
            <!-- band -->
            <div class="course-band grid grid-cols-12 items-center">
              <!-- LEFT: checkbox + title + icons + small schedule -->
              <div class="col-span-8 px-3 py-2 border-white/10 flex flex-col">
                <div class="flex items-center gap-2">
                  <input type="checkbox" class="size-5 rounded border-white/50"
                         x-model="c.checked" @change="persistChecked()" />
  
                  <div class="band-title font-crimson text-base font-semibold flex items-center gap-1.5">
                    <span x-text="c.title"></span>
  
                    <!-- ℹ️ info toggle (COURSE) -->
                    <button
                      type="button"
                      x-show="c.hasInfo"
                      @click="c.infoOpen = !c.infoOpen"
                      :aria-expanded="c.infoOpen"
                      :aria-controls="'acc-info-'+c.id"
                      data-toggle="desc"
                      class="text-xs bg-white/15 hover:bg-white/25 p-1.5 rounded"
                      title="Description &amp; Placement">
                      <span x-show="!c.infoOpen">i</span>
                      <span x-show="c.infoOpen">–</span>
                    </button>
  
                    <!-- ✏️ course note toggle -->
                    <button type="button"
                            @click="c.noteOpen = !c.noteOpen"
                            :aria-expanded="c.noteOpen"
                            :aria-controls="'acc-note-'+c.id"
                            class="text-xs bg-white/15 hover:bg-white/25 p-1.5 rounded"
                            title="Add / View Note">✏️</button>
                  </div>
                </div>
  
                <!-- schedule under title -->
                <div class="text-[0.8rem] opacity-90 leading-tight ml-7 mt-0.5"
                     x-html="c.summary || '<span class=opacity-60>—</span>'"></div>
              </div>
  
              <!-- RIGHT: course planning tags -->
              <div class="col-span-4 px-3 py-2 border-white/10 plan-anchor">
                <div class="flex items-center justify-end gap-3" x-data="{open:false}">
                  <!-- selected tags preview (only chosen ones) -->
                  <div class="tag-row" x-show="getUses(c.id).length">
                    <template x-for="val in getUses(c.id)" :key="val">
                      <span class="tag-chip">
                        <img :src="iconMap[val]" :alt="val">
                      </span>
                    </template>
                  </div>
              
                  <!-- Course Plan Button -->
                  <button type="button" class="plan-trigger course-plan-trigger"
                          @click="open=!open" :aria-expanded="open">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M20 6L9 17l-5-5"/>
                    </svg>
                    <span>Plan</span>
                  </button>
              
                  <!-- menu -->
                  <div class="plan-menu" x-show="open" x-transition @click.outside="open=false">
                    <div class="text-xs uppercase tracking-wide text-gray-500 px-2 pb-1">Add tags</div>
                    <template x-for="opt in useOptions" :key="opt.value">
                      <label class="plan-opt">
                        <input type="checkbox" class="mr-1"
                         :checked="getUses(c.id).includes(opt.value)"
                         @change="toggleUse(c.id,opt.value); /* open=false */">
                        <img :src="opt.icon" :alt="opt.label">
                        <span x-text="opt.label"></span>
                      </label>
                    </template>
                  </div>
                </div>
              </div>
            </div>
  
            <!-- accordion area -->
            <div x-show="c.noteOpen || (c.infoOpen && c.hasInfo)" x-collapse>
              <!-- NOTE (gray, full width) -->
              <section :id="'acc-note-'+c.id" x-show="c.noteOpen" class="accordion">
                <div class="note-area">
                  <label class="text-xs uppercase tracking-wide text-gray-500 block mb-1">
                    Planning Note (optional)
                  </label>
                  <textarea
                    :value="plan[c.id]?.note || ''"
                    @input="plan[c.id]={ ...(plan[c.id]||{}), note:$event.target.value, ts:Date.now() }; persistPlan();"
                    placeholder="Add any details for your plan (who it’s for, pacing, resources, etc.)"></textarea>
                </div>
              </section>
  
              <!-- INFO (white, full width) -->
              <section :id="'acc-info-'+c.id" x-show="c.infoOpen && c.hasInfo" class="acc-info">
                <div class="info-grid">
                  <template x-if="c.description">
                    <div class="info-col">
                      <h4>Description</h4>
                      <div class="copy" x-html="c.description"></div>
                    </div>
                  </template>
                  <template x-if="c.combining">
                    <div class="info-col">
                      <h4>Combining &amp; Placement</h4>
                      <div class="copy" x-html="c.combining"></div>
                    </div>
                  </template>
                </div>
              </section>
            </div>

        <!-- topics -->
        <template x-if="c.topics && c.topics.length">
          <div class="px-3 pb-3 topics-list">
            <div class="text-xs uppercase tracking-wide text-gray-500 mt-2 mb-1">Topics</div>
        
            <template x-for="t in c.topics" :key="t.topic_id">
              <div class="mb-2">
                <!-- Topic row -->
                <div class="topic-row">
                  <div class="topic-left">
                    <input type="checkbox" class="size-4 mt-0.5"
                           x-model="t.checked" @change="persistChecked()" />
                    <div>
                      <div class="flex items-center gap-1">
                        <span class="topic-title" x-text="t.topic_title"></span>
        
                        <!-- ℹ️ info toggle (TOPIC) -->
                        <button
                          x-show="t.hasInfo"
                          @click="t.infoOpen = !t.infoOpen"
                          :aria-expanded="t.infoOpen"
                          :aria-controls="'t-acc-info-'+t.topic_id"
                          data-toggle="desc"
                          class="topic-icon"
                          title="Description &amp; Placement">
                          <span x-show="!t.infoOpen">i</span><span x-show="t.infoOpen">–</span>
                        </button>
        
                        <!-- ✏️ topic note -->
                        <button @click="t.noteOpen = !t.noteOpen"
                                :aria-expanded="t.noteOpen"
                                :aria-controls="'t-acc-note-'+t.topic_id"
                                class="topic-icon"
                                title="Add / View Note">✏️
                        </button>
                      </div>
        
                      <!-- Topic schedule directly under title -->
                      <div class="topic-schedule"
                           x-html="t.summary || '<span class=opacity-60>—</span>'"></div>
                    </div>
                  </div>
        
                  <!-- Right-side topic planning (selected chips + trigger) -->
                  <div class="topic-icons plan-anchor" x-data="{open:false}">
                    <div class="flex items-center gap-3">
                      <!-- selected chips -->
                      <div class="tag-row" x-show="getUses(t.topic_id).length">
                        <template x-for="val in getUses(t.topic_id)" :key="val">
                          <span class="tag-chip">
                            <img :src="iconMap[val]" :alt="val">
                          </span>
                        </template>
                      </div>
                  
                      <!-- Topic Plan Button -->
                      <button type="button" class="plan-trigger"
                              @click="open=!open" :aria-expanded="open">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M20 6L9 17l-5-5"/>
                        </svg>
                        <span>Plan</span>
                      </button>
                    </div>
                  
                    <!-- menu -->
                    <div class="plan-menu" x-show="open" x-transition @click.outside="open=false">
                      <div class="text-xs uppercase tracking-wide text-gray-500 px-2 pb-1">Add tags</div>
                      <template x-for="opt in useOptions" :key="opt.value">
                        <label class="plan-opt">
                          <input type="checkbox" class="mr-1"
                                 :checked="getUses(t.topic_id).includes(opt.value)"
                                 @change="toggleUse(t.topic_id,opt.value)">
                          <img :src="opt.icon" :alt="opt.label">
                          <span x-text="opt.label"></span>
                        </label>
                      </template>
                    </div>
                  </div>
                </div>
        
                <!-- Topic accordions (full width under this topic) -->
                <div x-show="t.noteOpen || (t.infoOpen && t.hasInfo)" x-collapse>
                  <!-- Note tray (gray) -->
                  <section :id="'t-acc-note-'+t.topic_id" x-show="t.noteOpen" class="topic-acc-note">
                    <div class="topic-note-area">
                      <label class="text-xs uppercase tracking-wide text-gray-500 block mb-1">
                        Planning Note (topic)
                      </label>
                      <textarea
                        :value="plan[t.topic_id]?.note || ''"
                        @input="plan[t.topic_id]={ ...(plan[t.topic_id]||{}), note:$event.target.value, ts:Date.now() }; persistPlan()"
                        placeholder="Add any topic-specific notes"></textarea>
                    </div>
                  </section>
        
                  <!-- Info tray (white) -->
                  <section :id="'t-acc-info-'+t.topic_id" x-show="t.infoOpen && t.hasInfo" class="topic-acc-info">
                    <div class="info-grid">
                      <template x-if="t.description">
                        <div class="info-col">
                          <h4>Description</h4>
                          <div class="copy" x-html="t.description"></div>
                        </div>
                      </template>
                      <template x-if="t.combining">
                        <div class="info-col">
                          <h4>Combining &amp; Placement</h4>
                          <div class="copy" x-html="t.combining"></div>
                        </div>
                      </template>
                    </div>
                  </section>
                    </div> 
                  </div> 
                </template> 
              </div> 
            </template> 
          </div> 
        </div> 
      </template> 
    </div> 
  </template> 
</section> 

    <template x-if="!groupedFlat.length">
      <p class="text-center text-gray-500 py-12">No courses match your filters/view.</p>
    </template>
</section>

<!-- ===== PRINT-ONLY VIEW ===== -->
<section id="print-view" aria-hidden="true">
  <!-- Simple header -->
  <header class="mb-3" style="display:flex; align-items:center; gap:10px;">
    <img src="Alveary%20Lt.%20Green.png" alt="" style="height:32px;width:32px;object-fit:contain;">
    <h1 style="margin:0;color:#262b26;font:700 22px/1.1 'DM Sans',system-ui;">Alveary Course Planning</h1>
  </header>

  <!-- Subject groups (reuse groupedBySubject), filtered by scope -->
  <template x-for="grp in printData.groups" :key="grp.subject || 'other'">
    <div :style="{ '--subject-color': grp.color }">
      <div class="pv-subject" x-text="grp.subject || 'Other'"></div>

      <!-- Courses -->
      <template x-for="c in grp.items" :key="c.id">
        <div class="pv-card">
          <div style="display:flex; align-items:flex-start; gap:10px;">
            <div>
              <div class="pv-title" x-text="c.title"></div>
              <div class="pv-schedule" x-html="c.summary || '&nbsp;'"></div>
            </div>
            <!-- chosen planning tags (icon chips) -->
            <div class="pv-tags" x-show="getUses(c.id).length">
              <template x-for="val in getUses(c.id)" :key="val">
                <span class="pv-tag"><img :src="iconMap[val]" :alt="val"></span>
              </template>
            </div>
          </div>

          <!-- Course NOTE: only when course is checked -->
          <template x-if="printUI.includeNotes && c.checked && (plan[c.id]?.note || '').trim().length">
            <div class="pv-note">
              <label>Planning Note</label>
              <p x-text="plan[c.id].note"></p>
            </div>
          </template>
          
          <!-- Course INFO: only when course is checked -->
          <template x-if="printUI.includeInfo && c.checked && (c.description || c.combining)">
            <div class="pv-info">
              <template x-if="c.description">
                <div class="mb-1">
                  <label>Description</label>
                  <div class="pv-copy small" x-html="c.description"></div>
                </div>
              </template>
              <template x-if="c.combining">
                <div>
                  <label>Combining &amp; Placement</label>
                  <div class="pv-copy small" x-html="c.combining"></div>
                </div>
              </template>
            </div>
          </template>

          <!-- Topics -->
          <template x-for="t in topicsForPrint(c)" :key="t.topic_id">
            <div class="pv-topic">
              <div class="pv-row" style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px;">
                <!-- LEFT: title + schedule stacked -->
                <div>
                  <div class="pv-title" style="font-size:14px; font-weight:600;" x-text="t.topic_title"></div>
                  <div class="pv-schedule" style="margin-top:2px;" x-html="t.summary || '&nbsp;'"></div>
                </div>
            
                <!-- RIGHT: topic planning tags (chips) -->
                <div class="pv-tags" x-show="getUses(t.topic_id).length" style="white-space:nowrap;">
                  <template x-for="val in getUses(t.topic_id)" :key="val">
                    <span class="pv-tag"><img :src="iconMap[val]" :alt="val"></span>
                  </template>
                </div>
              </div>
          
              <!-- Topic NOTE (only if turned on and there is text) -->
              <template x-if="printUI.includeNotes && (plan[t.topic_id]?.note || '').trim().length">
                <div class="pv-note">
                  <label>Planning Note (topic)</label>
                  <p x-text="plan[t.topic_id].note"></p>
                </div>
              </template>
          
              <!-- Topic INFO (only if turned on and topic actually has info) -->
              <template x-if="printUI.includeInfo && (t.description || t.combining)">
                <div class="pv-info">
                  <template x-if="t.description">
                    <div class="mb-1">
                      <label>Description</label>
                      <div class="pv-copy small" x-html="t.description"></div>
                    </div>
                  </template>
                  <template x-if="t.combining">
                    <div>
                      <label>Combining &amp; Placement</label>
                      <div class="pv-copy small" x-html="t.combining"></div>
                    </div>
                  </template>
                </div>
              </template>
            </div>
          </template>
        </div>
      </template>
    </div>
  </template>
</section>
</div>

<script>
document.addEventListener('alpine:init', () => {
  Alpine.data('multiSelect', (cfg = {}) => ({
    /* state */
    value: Array.isArray(cfg.modelValue) ? cfg.modelValue : [],
    ['x-modelable'](){ return 'value' },
    searchable: !!cfg.searchable,
    open: false,
    placeholder: cfg.placeholder || 'Select…',
    options: cfg.options || [],  // [{value,label,icon?}]
    q: '',

    /* inline style so we can update position live */
    panelStyle: 'position:fixed;left:0;top:0;width:auto;z-index:7000;max-height:50vh;overflow:auto;',

    /* lifecycle */
    init(){
      this.$dispatch('input', this.value);

      // global clear
      window.addEventListener('ms:clear', this._msClear = () => {
        this.clear(); this.open = false; this.q = '';
      });

      // keep aligned while open
      this._onScroll = () => { if (this.open) this.updatePanelPos(this.$refs.msRoot); };
      this._onResize = () => { if (this.open) this.updatePanelPos(this.$refs.msRoot); };
      window.addEventListener('scroll', this._onScroll, true);
      window.addEventListener('resize', this._onResize);
      window.addEventListener('ms:reposition', () => {
        if (this.open) this.updatePanelPos(this.$refs.msRoot);
      });
    },

    /* computed */
    get shown(){
      if (!this.searchable || !this.q) return this.options;
      const k = this.q.toLowerCase();
      return this.options.filter(o => (o.label||'').toLowerCase().includes(k));
    },
    get labelChips(){
      const labels = this.options.filter(o => this.value.includes(o.value)).map(o => o.label);
      return (labels.length <= 3) ? labels : [...labels.slice(0,3), `+${labels.length-3}`];
    },

    /* actions */
    toggle(v){
      const set = new Set(this.value);
      set.has(v) ? set.delete(v) : set.add(v);
      this.value = Array.from(set);
      this.$dispatch('input', this.value);
    },
    clear(){ this.value = []; this.$dispatch('input', this.value); },
    isOn(v){ return this.value.includes(v); },
    closeOnEscape(e){ if (e.key === 'Escape') this.open = false; },

    /* position panel directly under its trigger, clamped to viewport only */
    updatePanelPos(rootEl){
      try{
        const trigger = rootEl.querySelector('.ms-trigger');
        if (!trigger) return;

        const r = trigger.getBoundingClientRect();
        const margin = 8;

        // desired left/width
        const width = Math.round(r.width);
        let left   = Math.round(r.left);

        // keep inside viewport horizontally
        left = Math.max(margin, Math.min(left, window.innerWidth - width - margin));

        // sit right under the trigger
        const desiredTop = Math.round(r.bottom + 6);

        // keep inside viewport vertically; if it would run past the bottom,
        // we just shrink the max-height (no upward “sticky floor” clamp)
        const maxH = Math.max(160, window.innerHeight - desiredTop - 12);
        const top  = Math.max(6, desiredTop); // don’t go off the very top

        this.panelStyle = `
          position:fixed;
          left:${left}px;
          top:${top}px;
          width:${width}px;
          max-height:${maxH}px;
          overflow:auto;
          z-index:7000;
        `;
      }catch{}
    },
  }));
});
</script>
  
<script>
function planningApp(){
  return {
    /* ---------- UI state ---------- */
    // BEFORE
    // search:'', filters:{subject:'', levelTag:'', planUse:''},
    
    // AFTER
    search: '',
    filters: {
      subjects: [],     // multi subject values (strings)
      levelTags: [],    // multi grade tags, e.g., ['G1','G2']
      planUses: []      // multi plan tags, e.g., ['Core','(none)']
},
    onlyPlanned:false, onlyChecked:false,
    step: 1,

    /* ---------- data ---------- */
    courses:[], courseIndex:{}, plan:{}, openGuidance:{},

    noteFor:null, noteDraft:'',
    modal:{title:'',description:'',combine:''},

    gradeLabelMap: Object.freeze({
      G1:'Grade 1', G2:'Grade 2', G3:'Grade 3', G4:'Grade 4', G5:'Grade 5',
      G6:'Grade 6', G7:'Grade 7', G8:'Grade 8', G9:'Grade 9', G10:'Grade 10',
      G11:'Grade 11', G12:'Grade 12'
    }),
    get gradeOptions(){
      // you already compute levelList (["G1","G2",...]); we just map it to labels
      return this.levelList.map(v => ({ value:v, label: this.gradeLabelMap[v] || v }));
    },
    normalizeLevelTags(){
      // If someone had a single-select saved earlier, make sure it’s an array now
      if (!Array.isArray(this.filters.levelTags)) {
        this.filters.levelTags = this.filters.levelTags ? [this.filters.levelTags] : [];
      }
    },

    // guidance blocks (uses your uploaded PNGs)
    guidance:[
      {
        key:'core', title:'Core Subjects', icon:'Core%20Subjects.png',
        html:`
          <p><strong>Start by focusing on the core subjects</strong> required by your state or those you consider nonnegotiable, such as Bible, History, Geography, English/Reading, Literature, Science, and Math.</p>
    
          <p>If you plan to modify a subject—such as focusing on only one stream of History (e.g., <em>World, Ancient,</em> or <em>US/Canadian for grades 4+</em>)—make a note of it. Similarly, if you intend to combine students into a single grade level for a subject (e.g., <em>2nd and 3rd graders sharing a 3rd-grade Science course</em>), make note of that too.</p>
    
          <p>Refer to our <a href="https://www.alveary.org/whats-new/tips-for-combining-students" target="_blank" rel="noopener" class="underline text-[var(--green-dark)] hover:opacity-80">tips on combining students</a> for additional guidance.</p>
        `
      },
      {
        key:'family', title:'Family & High-Interest', icon:'Family%20Subjects.png',
        html:`
          <p><strong>Next, choose a few subjects that spark high interest</strong> for each child or that your whole family would enjoy together.</p>
    
          <p>You can focus on the same subject throughout the year or rotate topics to explore a variety. For example, you might dedicate one term each to <em>Shakespeare, Plutarch,</em> and <em>Composer Study</em> if you don't have room for a full year of each. If you prefer a slower pace, consider spreading a term's worth of lessons across two terms.</p>
    
          <p>This approach works well for subjects such as <em>Art Instruction</em> or <em>Singing,</em> giving you the flexibility to adjust to your students' needs.</p>
        `
      },
      {
        key:'additional', title:'Additional Subjects', icon:'Additional%20Subjects.png',
        html:`
          <p><strong>Review the remaining subjects and choose one or two</strong> that feel especially important to include, especially if they haven’t been covered yet. Consider options that:</p>
    
          <ul class="list-disc pl-6 mt-2 mb-3 space-y-1">
            <li>Fulfill high-school credit requirements.</li>
            <li>Reflect your family’s priorities or interests.</li>
            <li>Align with your child’s passions or future goals.</li>
          </ul>
    
          <p>These could also be subjects where Alveary offers resources without daily lesson plans (e.g., <em>cooking</em> or <em>car maintenance</em>) or areas where you can incorporate non-Alveary resources, such as co-op classes or ACT prep courses.</p>
        `
      },
      {
        key:'plan', title:'Plan Your Year', icon:'Plan%20Your%20Year.png',
        html:`
          <p>Now that you’ve identified your subjects, you’re ready to <strong>create a schedule</strong> using Alveary’s scheduling tools. This is a great starting point for your school year.</p>
    
          <p>If you have room for additional subjects—or think you might later—make a list of what you’d like to include and why each is important. Consider adding these subjects when time allows.</p>
    
          <p>For guidance, refer to these Alveary resources:</p>
          <ul class="list-none mt-2 mb-1 space-y-1 pl-6">
            <li>∞ <a href="https://www.alveary.org/whats-new/a-relational-education" target="_blank" rel="noopener" class="underline text-[var(--green-dark)] hover:opacity-80">Relational Education</a> <span class="text-gray-600">(which subjects are intertwined)</span></li>
            <li>∞ <a href="http://www.alveary.org/whats-new/balancing-the-feast" target="_blank" rel="noopener" class="underline text-[var(--green-dark)] hover:opacity-80">Balancing the Feast</a> <span class="text-gray-600">(often overlooked subjects)</span></li>
            <li>∞ <a href="https://www.alveary.org/whats-new/tips-for-combining-students" target="_blank" rel="noopener" class="underline text-[var(--green-dark)] hover:opacity-80">Tips for Combining Students</a></li>
          </ul>
        `
      }
    ],

    useOptions:[
      {label:'Core Subject', value:'Core', icon:'Core%20Subjects.png'},
      {label:'Family', value:'Family', icon:'Family%20Subjects.png'},
      {label:'Combine', value:'Combine', icon:'Combine%20Subjects.png'},
      {label:'High Interest', value:'High Interest', icon:'High%20Interest%20Subjects.png'},
      {label:'Additional', value:'Additional', icon:'Additional%20Subjects.png'}
    ],

    /* ---------- sources (same as your list page) ---------- */
    dataSources:{
      courses:'https://docs.google.com/spreadsheets/d/e/2PACX-1vQsihZUzspkkv62sv-KxQOjiXIApm8W8fOO1f_y9sfhyLLTeJhGsq6l5k1BhONtEtw7q197VqdZqDN3/pub?gid=0&single=true&output=csv',
      topics: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQsihZUzspkkv62sv-KxQOjiXIApm8W8fOO1f_y9sfhyLLTeJhGsq6l5k1BhONtEtw7q197VqdZqDN3/pub?gid=1919021076&single=true&output=csv'
    },
    courseFields:{
      course_id:'Course_ID', course_title:'Course', subject:'Subject',
      schedule_text:'Scheduling_R3', grade_text:'Grade_Text', grade_filter:'Grade_Filter',
      description:'Program_Description_R3', combining_placement:'Combining&PlacementTips_R3'
    },
    topicFields:{
      topic_id:'Topic_ID', course_id:'Course_ID_R3', topic_title:'Topic',
      topic_description:'Program_Description_R3', combining_placement:'Combining&PlacementTips_R3',
      schedule_text:'Scheduling_R3', grade_text:'Grade_Text', grade_filter:'Grade_Filter'
    },

    subjectColors:{
        'Architecture': '#a0a6be',
        'Art': '#907061',
        'Bible': '#964945',
        'Citizenship': '#62765c',
        'English': '#9b5b7b',
        'Geography': '#4d8da2',
        'History': '#6b6bbf',
        'Latin': '#5a5373',
        'Life Skills': '#d1b358',
        'Literature': '#c07669',
        'Math': '#6d7eaa',
        'Modern Language': '#6db4b2',
        'Music': '#9e6bac',
        'Physical Education': '#bd855e',
        'Science': '#96a767',
        'Science & Alt. Science': '#96a767'
      },
      subjectColor(name){
        if(!name) return '#dfe4df';
        // loose match so "Science & Alt. Science" etc. resolve
        const key = Object.keys(this.subjectColors).find(k =>
          k.toLowerCase() === name.toLowerCase()
        );
        return key ? this.subjectColors[key] : '#dfe4df';
      },

    /* ---------- computed ---------- */
    get filtered(){
      this.ensureArrayFilters && this.ensureArrayFilters();
      const q = (this.search || '').toLowerCase();
      const isEmpty = a => !a || (Array.isArray(a) && a.length === 0);
      const anyIntersect = (a,b) => {
        if (!Array.isArray(a) || !Array.isArray(b) || !a.length || !b.length) return false;
        const set = new Set(a); return b.some(x => set.has(x));
      };
    
      const subjectsSel = this.filters.subjects || [];
      const levelsSel   = this.filters.levelTags || [];
      const plansSel    = this.filters.planUses  || [];
    
      return this.courses.filter(c=>{
        // text
        const matchesQ = !q || [c.title, c.subject, c.summary, c.levelDisplay].join(' ').toLowerCase().includes(q);
    
        // subject OR
        const matchesSubject = isEmpty(subjectsSel) || subjectsSel.includes(c.subject);
    
        // grade filter should match the COURSE only (topics follow the course)
        const matchesGrade = isEmpty(levelsSel) || anyIntersect(levelsSel, c.levelTags || []);
    
        // plan OR across course OR topics; "(none)" means no tags anywhere
        let matchesPlan = true;
        if (!isEmpty(plansSel)) {
          const courseUses   = (this.plan[c.id]?.use) || [];
          const topicUsesArr = (c.topics||[]).map(t => (this.plan[t.topic_id]?.use) || []);
          const anyTopicTagged = topicUsesArr.some(u => u.length);
          const hasAnyChosen =
            plansSel.some(tag => courseUses.includes(tag) || topicUsesArr.some(u => u.includes(tag)));
          const wantsNone = plansSel.includes('(none)');
          const isNone = courseUses.length === 0 && !anyTopicTagged;
          matchesPlan = wantsNone ? (isNone || hasAnyChosen) : hasAnyChosen;
        }
    
        // your existing toggles
        const passPlanned = !this.onlyPlanned ||
          (this.plan[c.id]?.use?.length) ||
          ((c.topics||[]).some(t => (this.plan[t.topic_id]?.use||[]).length));
    
        const passChecked = !this.onlyChecked || c.checked || (c.topics||[]).some(t=>t.checked);
    
        return matchesQ && matchesSubject && matchesGrade && matchesPlan && passPlanned && passChecked;
      });
    },
    get groupedFlat(){
      const by = new Map();
      this.filtered.forEach(c=>{ const s=c.subject||'Other'; if(!by.has(s)) by.set(s,[]); by.get(s).push(c); });
      const special='Alt. Science Options';
      return Array.from(by.entries()).sort((a,b)=>{
        const A=a[0]||'', B=b[0]||'';
        if(A===special && B!==special) return 1;
        if(B===special && A!==special) return -1;
        return A.localeCompare(B,undefined,{numeric:true});
      }).flatMap(x=>x[1]);
    },
    get selectedCount(){
      return this.courses.reduce((n,c)=> n + (c.checked?1:0) + ((c.topics||[]).filter(t=>t.checked).length), 0);
    },
    get subjectList(){ return [...new Set(this.courses.map(c=>c.subject).filter(Boolean))].sort((a,b)=>a.localeCompare(b,undefined,{numeric:true})); }
    ,get levelList(){ return [...new Set(this.courses.flatMap(c=>c.levelTags||[]))].sort((a,b)=> {
      const na=+a.replace(/\D/g,''); const nb=+b.replace(/\D/g,''); return na-nb || a.localeCompare(b);
    }); },

    get groupedCourses(){
        // assumes you already have coursesFiltered – use whatever your filtered array name is
        const arr = this.coursesFiltered || this.courses; 
        return arr.reduce((out, c) => {
          const subj = c.subject || 'Other';
          const last = out[out.length-1];
          if(!last || last.subject !== subj){
            out.push({ subject: subj, color: this.subjectColor(subj), items:[c] });
          }else{
            last.items.push(c);
          }
          return out;
        }, []);
      },

      get groupedBySubject(){
          const arr = this.groupedFlat || [];  // ← filtered + subject-sorted flat list
          return arr.reduce((out, c) => {
            const subj = c.subject || 'Other';
            const last = out[out.length - 1];
            if (!last || last.subject !== subj) {
              out.push({ subject: subj, color: this.subjectColor(subj), items: [c] });
            } else {
              last.items.push(c);
            }
            return out;
          }, []);
        },

    /* ---------- helpers ---------- */
    _getCI(row,want){ const keys=Array.isArray(want)?want:[want]; for(const k of keys){ const hit=Object.keys(row).find(h=>h.trim().toLowerCase()===String(k).trim().toLowerCase()); if(hit) return row[hit]; } },
    computeGradeTags(gr){
      const tags=[]; const range=gr&&gr.match(/^(?:[Gg]?(\d+))\s*[–-]\s*[Gg]?(\d+)$/);
      if(range){ const a=+range[1],b=+range[2]; for(let i=Math.min(a,b); i<=Math.max(a,b); i++) tags.push(`G${i}`); return tags; }
      const single=gr&&gr.match(/^[Gg]?(\d+)$/); if(single) return [`G${+single[1]}`];
      if(gr && String(gr).includes(',')){ String(gr).split(',').forEach(x=>{ const n=x.replace(/[^0-9]/g,''); if(n) tags.push(`G${+n}`); }); }
      return tags;
    },
    rowToCourse(row){
      const g = (k) => this._getCI(row, this.courseFields[k]);
    
      const idRaw   = (g('course_id') || '').toString().trim();
      const titleRaw= (g('course_title') || '').toString().trim();
      if(!idRaw && !titleRaw) return null;
    
      const subject     = (g('subject') || '').toString().trim();
      const gradeText   = (g('grade_text') || '').toString().trim();
      const gradeFilter = (g('grade_filter') || '').toString().trim();
    
      // Scheduling now shows under the title
      const schedule    = (g('schedule_text') || '').toString().trim();
    
      const description = (g('description') || '').toString().trim();
      const combining   = (g('combining_placement') || '').toString().trim();
    
      const levelDisplay = gradeText || '';
      const levelTags = (gradeFilter && /G\s*\d+/i.test(gradeFilter))
        ? (gradeFilter.match(/G\s*\d+/gi) || []).map(s => 'G' + s.replace(/[^0-9]/g,''))
        : this.computeGradeTags(gradeText);
    
      const details = [];
      if (description) details.push({ label:'Description',            value: description });
      if (combining)   details.push({ label:'Combining & Placement', value: combining   });
    
      const hasInfo = !!(description || combining);
    
      return {
        id: idRaw || titleRaw,
        title: titleRaw || idRaw,
        subject,
    
        // used under the title
        summary: schedule,
    
        // info content
        details, description, combining, hasInfo,
    
        // filters
        levelDisplay, levelTags,
    
        // selection + topics
        checked: false,
        topics: [],
    
        // course accordions
        infoOpen: true,   // ℹ️ toggles this; default open
        noteOpen: false    // ✏️ toggles this
      };
    },
    rowToTopic(row){
      const g=(k)=>this._getCI(row,this.topicFields[k]);
    
      const rawCourseIds = (g('course_id')||'').toString().trim();
      const topic_title  = (g('topic_title')||'').toString().trim();
      if(!rawCourseIds || !topic_title) return null;
    
      const topic_id     = (g('topic_id')||'').toString().trim() || (rawCourseIds+'::'+topic_title);
      const topic_desc   = (g('topic_description')||'').toString().trim();
      const combining    = (g('combining_placement')||'').toString().trim();
      const schedule_t   = (g('schedule_text')||'').toString().trim();
    
      const gradeText    = (g('grade_text')||'').toString().trim();
      const gradeFilter  = (g('grade_filter')||'').toString().trim();
      const levelDisplay = gradeText || '';
      const levelTags = (gradeFilter && /G\s*\d+/i.test(gradeFilter))
        ? (gradeFilter.match(/G\s*\d+/gi)||[]).map(s=>'G'+s.replace(/[^0-9]/g,''))
        : this.computeGradeTags(gradeText);
    
      const details=[]; if(topic_desc) details.push({label:'Description', value:topic_desc});
      if(combining) details.push({label:'Combining & Placement', value:combining});
    
      const hasInfo = !!(topic_desc || combining);
    
      return {
        topic_id,
        course_ids: rawCourseIds.split(',').map(s=>s.trim()).filter(Boolean),
        topic_title,
        summary: schedule_t,
        details,
        description: topic_desc,
        combining,
        levelDisplay, levelTags,
        checked:false,
    
        /* Per-topic accordions */
        hasInfo,
        infoOpen: true,   // ℹ️ toggles this; default open
        noteOpen: false    // ✏️ toggles this
      };
    },

    measureBars(){
      // read actual heights (accounts for padding, borders, responsive changes)
      const mini = this.$root.querySelector('.mini-steps');
      const actions = document.getElementById('actionsBar');
    
      const miniH = mini ? Math.ceil(mini.getBoundingClientRect().height) : 0;
      // only count print bar on Step 3
      const printH = (this.step === 3 && actions)
        ? Math.ceil(actions.getBoundingClientRect().height)
        : 0;
    
      document.documentElement.style.setProperty('--mini-steps-h', `${miniH}px`);
      document.documentElement.style.setProperty('--printbar-h', `${printH}px`);
    },
    isRefreshing: false,

    refreshData: async function (){
      try{
        this.isRefreshing = true;
    
        // clear our local cache so we fetch again
        localStorage.removeItem('pf_csv_cache_v1');
    
        // re-load CSVs in-place (force fresh) and rebuild courses
        await this.loadDualCSVs({ forceFresh: true });
    
        // keep all current UI state (filters, selections, plan)
        this.restoreChecked();
        this.loadPlan();
    
        // settle layout + reposition any open menus
        this.$nextTick(() => {
          this.measureBars && this.measureBars();
          window.dispatchEvent(new CustomEvent('ms:reposition'));
        });
      }finally{
        this.isRefreshing = false;
      }
    },

    ensureArrayFilters(){
      const f = this.filters || {};
      if (!Array.isArray(f.subjects))  f.subjects  = [];
      if (!Array.isArray(f.levelTags)) f.levelTags = [];
      if (!Array.isArray(f.planUses))  f.planUses  = [];
      this.filters = f;
    },

    /* ---------- storage & sync ---------- */
    persistStep(){ localStorage.setItem('pf_step', String(this.step)); },
    openStep(n){
      this.step = Math.min(3, Math.max(1, Number(n)||1));
      this.persistStep();
      this.$nextTick(()=> this.measureBars());   // recalc offsets
      window.dispatchEvent(new CustomEvent('ms:reposition'));
    },
    nextStep(){ if(this.step < 3) this.openStep(this.step + 1); },
    prevStep(){ if(this.step > 1) this.openStep(this.step - 1); },
    
    persistChecked(){
      const ids=[]; this.courses.forEach(c=>{ if(c.checked) ids.push('c:'+c.id); (c.topics||[]).forEach(t=>{ if(t.checked) ids.push('t:'+t.topic_id); }); });
      localStorage.setItem('pf_courses', JSON.stringify(ids));
    },
    restoreChecked(){
      try{
        const saved=JSON.parse(localStorage.getItem('pf_courses')||'[]'); const set=new Set(saved);
        this.courses.forEach(c=>{ c.checked=set.has('c:'+c.id); (c.topics||[]).forEach(t=>{ t.checked=set.has('t:'+t.topic_id); }); });
      }catch{}
    },
    loadPlan(){ try{ this.plan=JSON.parse(localStorage.getItem('pf_plan_v1')||'{}'); }catch{ this.plan={}; } },
    persistPlan(){ localStorage.setItem('pf_plan_v1', JSON.stringify(this.plan)); },
    setUse(id, use) {
      const existing = this.plan[id]?.use || [];
      // Normalize to array
      const currentUses = Array.isArray(existing) ? existing : existing ? [existing] : [];
    
      // If already selected, remove it; otherwise add it
      const newUses = currentUses.includes(use)
        ? currentUses.filter(u => u !== use)
        : [...currentUses, use];
    
      this.plan[id] = { ...(this.plan[id] || {}), use: newUses, ts: Date.now() };
      this.persistPlan();
    },
    setTopicUse(tid, use){
      const existing = this.plan[tid]?.use || [];
      const uses = Array.isArray(existing) ? existing : (existing ? [existing] : []);
      const newUses = uses.includes(use) ? uses.filter(u=>u!==use) : [...uses, use];
      this.plan[tid] = { ...(this.plan[tid]||{}), use:newUses, ts:Date.now() };
      this.persistPlan();
    },
    topicHasUse(tid, val){
      const u = this.plan[tid]?.use || [];
      return Array.isArray(u) ? u.includes(val) : u===val;
    },

    iconMap:{
      'Core':'Core%20Subjects.png',
      'Family':'Family%20Subjects.png',
      'Combine':'Combine%20Subjects.png',
      'High Interest':'High%20Interest%20Subjects.png',
      'Additional':'Additional%20Subjects.png'
    },
    iconsFor(use){
      const uses = Array.isArray(use) ? use : (use ? [use] : []);
      return uses
        .map(u => this.iconMap[u])
        .filter(Boolean); // skip empty/unknown (e.g., Undecided)
    },

    getUses(id){
      const u = this.plan[id]?.use ?? [];
      return Array.isArray(u) ? u : (u ? [u] : []);
    },
    toggleUse(id, val){
      const cur = this.getUses(id);
      const next = cur.includes(val) ? cur.filter(v=>v!==val) : [...cur, val];
      this.plan[id] = { ...(this.plan[id]||{}), use: next, ts: Date.now() };
      this.persistPlan();
    },

    /* ---------- guidance open/close memory ---------- */
    isOpen(key){ return this.openGuidance[key] ?? (key==='core'); },
    toggleOpen(key,val){ this.openGuidance[key]=!!val; localStorage.setItem('pf_guidance_open', JSON.stringify(this.openGuidance)); },

    /* ---------- load ---------- */
    async loadDualCSVs(opts = {}){
      const forceFresh = !!opts.forceFresh;
      const cacheKey = 'pf_csv_cache_v1';
      const maxAgeMs = 6*60*60*1000;
      const now = Date.now();
    
      // helper to add a cache-buster
      const bust = (url) => url + (url.includes('?') ? '&' : '?') + 't=' + now;
    
      // 1) use cache when allowed and fresh
      if (!forceFresh){
        let cached;
        try { cached = JSON.parse(localStorage.getItem(cacheKey) || 'null'); } catch{}
        if (cached && (now - cached.ts) < maxAgeMs){
          const pc = Papa.parse(cached.courses, { header:true, skipEmptyLines:true });
          const pt = Papa.parse(cached.topics,  { header:true, skipEmptyLines:true });
          return this.applyParsed(pc, pt);
        }
      }
    
      // 2) fetch fresh (no-store) with a cache-busting query
      const [cCSV, tCSV] = await Promise.all([
        fetch(bust(this.dataSources.courses), { cache:'no-store' }).then(r=>r.text()),
        fetch(bust(this.dataSources.topics),  { cache:'no-store' }).then(r=>r.text()),
      ]);
    
      // 3) update cache for normal loads
      localStorage.setItem(cacheKey, JSON.stringify({ ts: now, courses: cCSV, topics: tCSV }));
    
      const pc = Papa.parse(cCSV, { header:true, skipEmptyLines:true });
      const pt = Papa.parse(tCSV, { header:true, skipEmptyLines:true });
      this.applyParsed(pc, pt);
    },
    applyParsed(pc,pt){
      this.courseIndex = {};
        pc.data.forEach(row => {
          const c = this.rowToCourse(row);
          if (c) this.courseIndex[c.id] = c;
        });
        
        // Clone each topic per course and make its id course-specific
        pt.data.forEach(row => {
          const t = this.rowToTopic(row);
          if (!t) return;
        
          t.course_ids.forEach(cid => {
            const course = this.courseIndex[cid];
            if (!course) return;
        
            // make a unique id for the *topic as used in this course*
            const tForCourse = {
              ...t,
              topic_id: `${t.topic_id}::${cid}`  // unique per course
            };
            course.topics.push(tForCourse);
          });
        });
        
        this.courses = Object.values(this.courseIndex);
        this.dataReady = true;
      },

    /* ---------- actions ---------- */
    showAllTips: false,

    toggleAllTips(open){
      const on = !!open;
    
      // 1) Flip Alpine state directly (fast + reliable)
      this.courses.forEach(c => {
        c.infoOpen = on && c.hasInfo;
        (c.topics || []).forEach(t => { t.infoOpen = on && t.hasInfo; });
      });
    
      // 2) Back-compat: nudge any legacy DOM toggles that aren't bound to Alpine
      // (keeps your previous click-driven behavior working where needed)
      const selectors = ['[data-toggle="desc"]', '[data-toggle="cnp"]'];
      selectors.forEach(sel => {
        document.querySelectorAll(sel).forEach(btn => {
          const isOpen = btn.getAttribute('aria-expanded') === 'true';
          if (on && !isOpen)  btn.click();
          if (!on && isOpen)  btn.click();
        });
      });
    
      // 3) Recompute sticky offsets after the layout expands/collapses
      this.$nextTick(() => this.measureBars && this.measureBars());
      window.dispatchEvent(new CustomEvent('ms:reposition'));
    },
    // Single place to reset every filter control
    resetFilters(){
      this.search = '';
      this.filters = { subjects: [], levelTags: [], planUses: [] };
      this.onlyPlanned = false;
      this.onlyChecked = false;
    },
    
    // "Clear filters" button – just resets filters (keeps selections/plan)
    clearFilters(){
      this.resetFilters();
    
      // tell all multiSelects + the subject search to visually clear & close
      window.dispatchEvent(new CustomEvent('ms:clear'));
    
      this.$nextTick(() => this.measureBars && this.measureBars());
      window.dispatchEvent(new CustomEvent('ms:reposition'));
    },
    
    // "Clear selected" (Clear All) button – clears checks, plan, AND filters
    clearAll(){
      // uncheck every course/topic
      (this.courses || []).forEach(c => {
        c.checked = false;
        (c.topics || []).forEach(t => t.checked = false);
      });
      this.persistChecked();
    
      // wipe plan tags everywhere
      this.plan = {};
      this.persistPlan();
    
      // and also reset all filters
      this.resetFilters();
    
      // optional: if you want to force descriptions & tips back ON when clearing all:
      // this.showAllTips = true; this.applyTipsState();
    
      this.$nextTick(() => this.measureBars && this.measureBars());
      window.dispatchEvent(new CustomEvent('ms:reposition'));
    },
    printSelected(){ window.print(); },

    async init(){
      // restore last step (defaults to 1)
      const savedStep = Number(localStorage.getItem('pf_step') || '1');
      this.step = Math.min(3, Math.max(1, savedStep));
      
      // load guidance open state
      try{ this.openGuidance = JSON.parse(localStorage.getItem('pf_guidance_open')||'{}'); }catch{ this.openGuidance={}; }

      await this.loadDualCSVs();
      this.restoreChecked();
      this.loadPlan();
      
      if (!Array.isArray(this.filters?.subjects))  this.filters.subjects  = [];
      if (!Array.isArray(this.filters?.levelTags)) this.filters.levelTags = [];
      if (!Array.isArray(this.filters?.planUses))  this.filters.planUses  = [];
      
      this.$nextTick(() => {
      // 1) first paint: measure once
      this.measureBars && this.measureBars();
        window.dispatchEvent(new CustomEvent('ms:reposition'));
    
      // 2) ensure initial open/closed state matches the switch
      this.toggleAllTips(this.showAllTips);
    
      // 3) after layout settles (fonts, sticky, etc.), measure again
      setTimeout(() => this.measureBars && this.measureBars(), 60);
        window.dispatchEvent(new CustomEvent('ms:reposition'));
    });
    
    window.addEventListener('resize', () => this.measureBars());
      window.dispatchEvent(new CustomEvent('ms:reposition'));
    
    // keep this (ensures course/topic accordions match showAllTips)
    this.applyTipsState();
    },
    // --- NEW/ensure these exist in state ---
    showAllTips: true,     // when true: descriptions & tips are OPEN
    onlyChecked: false,    // your existing flag for "Show only selected"
    
    // --- Add or replace this helper ---
    applyTipsState(){
      const open = !!this.showAllTips;
      (this.courses || []).forEach(c => {
        c.infoOpen = open;
        (c.topics || []).forEach(t => t.infoOpen = open);
      });
    },
    
    // --- OPTIONAL: keep a single toggle method for the switch ---
    toggleTips(){
      this.showAllTips = !this.showAllTips;
      this.applyTipsState();
    },
    
    /* ---------- PRINT STATE ------------ */
    // ---- Print UI state + data for the print-only view ----
    printUI: {
      open:false,
      scope:'all',          
      includeInfo:false,
      includeNotes:false,
      selectedOnly:false,    
      filtered:false,      
      warning:''             
    },
    printData: { groups: [] },
    dataReady: false,
    
    // tiny helper: resolves when courses have loaded & are available
    waitForData(){
      return new Promise(resolve=>{
        if (this.courses && this.courses.length) return resolve();
        const iv = setInterval(()=>{
          if (this.courses && this.courses.length){
            clearInterval(iv);
            resolve();
          }
        }, 30);
      });
    },

    topicsForPrint(c){
        // Whole list (Filters ON): show all topics
        if (this.printUI.scope === 'all') return c.topics || [];
      
        // Whole list (Filters OFF): also show all topics
        if (this.printUI.scope === 'all_nofilter') return c.topics || [];
      
        // Selected only:
        // If the course is checked, include all its topics; otherwise include only selected topics
        if (c.checked) return c.topics || [];
        return (c.topics || []).filter(t => t.checked);
      },
  
    // Build the data snapshot that the print view will render
    buildPrintGroups(){
      // Consider these as "active filters" for printing
      const f = this.filters || {};
      const hasFilters = !!(
        (this.search && this.search.trim()) ||
        (Array.isArray(f.subjects)  && f.subjects.length) ||
        (Array.isArray(f.levelTags) && f.levelTags.length) ||
        (Array.isArray(f.planUses)  && f.planUses.length) ||
        this.onlyPlanned || this.onlyChecked
      );
    
      let source;
    
      if (this.printUI.scope === 'selected') {
        // Only courses that are checked or have at least one checked topic
        source = this.courses.filter(c => c.checked || (c.topics||[]).some(t => t.checked));
      } else if (this.printUI.scope === 'all_nofilter') {
        // Completely ignore on-screen filters
        source = this.courses.slice();  // fresh array = no stale reference
      } else {
        // 'all' = whole list but respect current filters (search, subject, grade, plan, Show only planned/checked)
        // If no filters are active, fall back to all courses (prevents printing blank)
        source = hasFilters ? (this.filtered || this.courses) : this.courses;
      }
    
      // Group by subject (unchanged)
      const grouped = source.reduce((out, c) => {
        const subj = c.subject || 'Other';
        const last = out[out.length - 1];
        if (!last || last.subject !== subj) {
          out.push({ subject: subj, color: this.subjectColor(subj), items:[c] });
        } else {
          last.items.push(c);
        }
        return out;
      }, []);
    
      this.printData.groups = grouped;
    },

    // Build groups for "Whole list (Filters OFF)" — always every course/topic
    buildPrintGroupsAllNoFilter(){
      // fresh copy (avoid stale references)
      const source = this.courses.slice();
    
      // Group by subject (same logic as elsewhere)
      const grouped = source.reduce((out, c) => {
        const subj = c.subject || 'Other';
        const last = out[out.length - 1];
        if (!last || last.subject !== subj) {
          out.push({ subject: subj, color: this.subjectColor(subj), items:[c] });
        } else {
          last.items.push(c);
        }
        return out;
      }, []);
    
      this.printData.groups = grouped;
    },
    
    async printAllInline(){
      // Ensure data is present
      await this.waitForData();
    
      // Force "Whole list (Filters OFF)" and build a fresh snapshot
      this.printUI.scope = 'all_nofilter';
      this.buildPrintGroupsAllNoFilter();
    
      // Close any open dialog just in case
      this.printUI.open = false;
    
      // Wait for Alpine to render the print DOM, then give the browser two RAFs
      await this.$nextTick();
      const pv = this.$root.querySelector('#print-view');
      if (pv) { void pv.offsetHeight; }  // force reflow
    
      await new Promise(r=>requestAnimationFrame(()=>requestAnimationFrame(r)));
      window.print();
    },

    openPrintDialog(){
      this.printUI.warning = '';
      this.printUI.open = true;
      this.$nextTick(()=> this.measureBars());
      window.dispatchEvent(new CustomEvent('ms:reposition'));
    },
    hasActiveFilters(){
      const f = this.filters || {};
      return !!(
        (this.search && this.search.trim()) ||
        (Array.isArray(f.subjects)  && f.subjects.length) ||
        (Array.isArray(f.levelTags) && f.levelTags.length) ||
        (Array.isArray(f.planUses)  && f.planUses.length) ||
        this.onlyPlanned || this.onlyChecked
      );
    },
  
    // Called when user clicks "Preview & Print"
    async doPrint(){
      await this.waitForData();
    
      // decide scope from checkboxes (precedence: Selected > Filtered > Whole list OFF)
      if (this.printUI.selectedOnly) {
        const anySelected = this.courses.some(c => c.checked) ||
                            this.courses.some(c => (c.topics||[]).some(t => t.checked));
        if (!anySelected) {
          this.printUI.warning = 'Nothing is selected. Check at least one course or topic, or uncheck “Print Selected.”';
          return; // keep the dialog open
        }
        this.printUI.scope = 'selected';
      } else if (this.printUI.filtered) {
        if (!this.hasActiveFilters()) {
          this.printUI.warning = 'No filters/search are active. Add one, or uncheck “Print Filtered.”';
          return; // keep the dialog open
        }
        this.printUI.scope = 'all';           // “Whole list (Filters ON)”
      } else {
        this.printUI.scope = 'all_nofilter';  // “Whole list (Filters OFF)”
      }
    
      // build the snapshot for #print-view
      if (this.printUI.scope === 'all_nofilter') {
        this.buildPrintGroupsAllNoFilter();
      } else {
        this.buildPrintGroups();
      }
    
      // close and print
      this.printUI.open = false;
      await this.$nextTick();
      const pv = this.$root.querySelector('#print-view');
      if (pv) { void pv.offsetHeight; }                 // force reflow
      await new Promise(r=>requestAnimationFrame(()=>requestAnimationFrame(r)));
      window.print();
    },
  }
}
</script>
</body>
</html>
